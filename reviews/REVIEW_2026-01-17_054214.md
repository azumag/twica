# TwiCa Code Review

**Review Date:** 2026-01-17
**Reviewed by:** Code Review Agent
**Architecture Document:** docs/ARCHITECTURE.md
**Implementation Document:** docs/IMPLEMENTED.md

---

## 概要

TwiCaプロジェクトのコードレビューを実施しました。前回レビューからの修正状況、新しく発見された問題、および現在のコード品質を評価しました。

**総合評価:** 重大な問題あり（実装エージェントへのフィードバックが必要）

---

## 1. 前回レビューからの修正状況

### 1.1 修正済み

| 項目 | 状態 |
|:---|:---:|
| GachaServiceの重複ロジック | ✅ |
| カードAPI所有権検証 | ✅ |
| selectWeightedCardゼロ重み処理 | ✅ |
| セッションCookie名の定数使用 | ✅ |

### 1.2 未修正（新規含む）

| 項目 | 重要度 | 状態 |
|:---|:---:|:---:|
| ストレージ選定の不一致 | 高 | ❌ 未修正 |
| カード重複収集の可能性 | 高 | ❌ 新規発見 |
| ファイル拡張子抽出の問題 | 中 | ❌ 未修正 |
| eslintコメントの整理 | 低 | ❌ 未修正 |
| レート制限 | 低 | ❌ 未修正 |

---

## 2. 重大な問題

### 2.1 ストレージ選定の不一致 ⚠️ 重要

**重要度: 高**

設計書（docs/ARCHITECTURE.md）では画像ストレージに「Vercel Blob」を使用すると明記されていますが、実装では`src/app/api/upload/route.ts`で`supabase.storage`を使用しています。

**設計書との不一致:**
```markdown
### 画像ストレージ
**選択**: Vercel Blob
```

**実際の実装** (`src/app/api/upload/route.ts:34-43`):
```typescript
const { data, error } = await supabase.storage
  .from('card-images')
  .upload(fileName, file, {
```

**影響:**
- 設計書と実装の不一致により、以降のメンテナンスで混乱を招く
- Vercel BlobのCDN配信パフォーマンスが活用できていない

**推奨事項:**
- 設計書を更新してSupabase Storageに合わせる、または
- 実装をVercel Blobに移行する

---

### 2.2 カード重複収集の可能性 ⚠️ 重要

**重要度: 高**

`src/lib/services/gacha.ts`の`executeGacha`関数で、ユーザー同じカードを複数回引くたびに`user_cards`テーブルに新しいレコードが挿入されます。これにより、同じカードがユーザーに重複して所有される可能性があります。

**問題箇所** (`src/lib/services/gacha.ts:60-66`):
```typescript
const { error: collectionError } = await this.supabase
  .from('user_cards')
  .insert({
    user_id: user.id,
    card_id: selectedCard.id,
  })
```

**問題点:**
- `user_cards`テーブルに一意制約がない場合、重複データが発生
- ユーザーのコレクション表示で同じカードが重複して表示される
- 将来的にカード所持枚数制限などの機能を実装する際の障害

**推奨事項:**
```typescript
// upsertを使用し、ON CONFLICTで重複を防ぐ
const { error: collectionError } = await this.supabase
  .from('user_cards')
  .upsert({
    user_id: user.id,
    card_id: selectedCard.id,
    obtained_at: new Date().toISOString(),
  }, {
    onConflict: 'user_id, card_id',
    ignoreDuplicates: true,
  })
```

**データベース側での対応:**
```sql
-- user_cardsテーブルに一意制約を追加
ALTER TABLE user_cards ADD CONSTRAINT unique_user_card UNIQUE (user_id, card_id);
```

---

## 3. 中程度の問題

### 3.1 ファイル拡張子抽出の問題

**重要度: 中**

`src/app/api/upload/route.ts`でファイル拡張子の抽出に`split('.').pop()`を使用しています。

**問題箇所** (`src/app/api/upload/route.ts:35`):
```typescript
const ext = file.name.split('.').pop();
```

**問題:**
- ファイル名`my.file.name.jpg`の場合、`split('.').pop()`は`jpg`ではなく`name`を返す
- 拡張子が正しく取得できない場合、ファイルが正常に処理されない可能性がある

**推奨事項:**
```typescript
const ext = file.name.slice(((file.name.lastIndexOf('.') - 1) >>> 0) + 2);
```

または、より読みやすい方法:
```typescript
const lastDotIndex = file.name.lastIndexOf('.');
const ext = lastDotIndex > -1 ? file.name.slice(lastDotIndex + 1) : '';
```

---

## 4. 軽微な問題

### 4.1 eslint-disable-next-lineコメント

**重要度: 低**

以下のファイルで不必要な`eslint-disable-next-line`コメントが残っています:

- `src/app/api/cards/[id]/route.ts:38, 107`
- `src/app/api/twitch/eventsub/route.ts:26`

**推奨事項:** 適切な型定義を使用して、これらのコメントを削除してください。

---

### 4.2 レート制限の欠如

**重要度: 低（オプション）**

以下のAPIエンドポイントにレート制限がありません:
- `/api/upload` - 画像アップロード
- `/api/gacha` - ガチャ実行
- `/api/cards` - カード管理

**推奨事項:** Vercelのレート制限機能、またはupstash/ratelimitなどのライブラリを検討してください。

---

## 5. セキュリティ上の検討事項

### 5.1 画像アップロードの検証

`src/app/api/upload/route.ts`ではファイルサイズとMIMEタイプの検証が行われていますが、以下の追加検証を推奨します:

- ファイル内容の検証（magic number check）
- ファイル名のサニタイズ
- アップロード頻度の制限

---

## 6. コード品質評価

### 6.1 良い点

- **TypeScript型安全性**: 適切に型定義が使用されています
- **環境変数検証**: `src/lib/env-validation.ts`で必須環境変数が検証されています
- **エラーハンドリング**: `Result`型和`handleApiError`関数が適切に実装されています
- **認証フロー**: CSRF対策（stateパラメータ）、セッション管理が適切に実装されています
- **署名検証**: Twitch EventSubの署名検証が実装されています

### 6.2 改善が必要な点

- 画像アップロードのファイル名処理
- カードコレクションの一意性保証

---

## 7. 設計書との整合性

### 7.1 整合性のない項目

| 設計書項目 | 実装状況 | 备注 |
|:---|:---:|:---|
| Vercel Blobストレージ | ❌ Supabase Storageを使用 | 要修正 |
| データベースRLSポリシー | ⚠️ 未設定の可能性 | 要確認 |

---

## 8. テスト

### 8.1 既存のテスト

`tests/unit/gacha.test.ts`で重み付き選択アルゴリズムのテストが適切に実装されています。

### 8.2 推奨される追加テスト

- APIエラーハンドリングのテスト
- 認証フローのテスト
- ファイルアップロードのテスト
- Realtime接続のテスト
- カード重複挿入のテスト

---

## 9. 総括

TwiCaプロジェクトには、重大な問題が2つ発見されました:

**重大な問題:**
1. ストレージ選定の不一致（設計書と実装）
2. カード重複収集の可能性

これらの問題は、QAプロセスに進む前に修正する必要があります。

**軽微な問題:**
- ファイル拡張子抽出の問題（中程度）
- eslintコメントの整理（低）
- レート制限（オプション）

**総合評価:** 実装エージェントへのフィードバックを行い、重大な問題を修正后再レビューを実施してください。

---

## チェックリスト

### 設計書との整合性
- [ ] ストレージ選定の一貫性（設計書更新または実装変更が必要）
- [ ] データベースRLSポリシーの設定確認

### セキュリティ
- [x] Twitch OAuth認証
- [x] CSRF対策
- [x] 署名検証
- [ ] レート制限（オプション）

### コード品質
- [x] TypeScript型安全性
- [x] 環境変数検証
- [ ] 定数の使用
- [ ] eslintコメントの整理

### 機能
- [x] カード管理機能
- [x] ガチャ機能
- [x] オーバーレイ表示
- [ ] カード所有者検証
- [ ] カード重複防止（重要）

---

## 結論

**実装エージェントへのフィードバックを送信してください。**

重大な問題（ストレージ不一致とカード重複）が発見されました。修正后再レビューを行い、問題がない場合にQAエージェントへの依頼を行ってください。

**フィードバック内容:**
- ストレージ選定を設計書に合わせてVercel Blobに変更、または設計書を更新
- カードコレクションに一意制約を追加し、重複を防止
- ファイル拡張子抽出ロジックを修正
