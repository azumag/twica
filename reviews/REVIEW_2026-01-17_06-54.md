# コードレビュー

## レビュー日

2026-01-17

## レビュー対象

Issue #11: カードアップロード容量制限の実装

## レビュー結果: 修正依頼あり

以下の問題が発見されました。実装エージェントにフィードバックを行ってください。

---

## 発見された問題

### 1. セキュリティ上の問題: MIME тип проверки может быть подделана (高)

**場所**: `src/lib/upload-validation.ts:34`

**問題**: 現在の実装では `file.type` のみをチェックしていますが、これはブラウザが提供するMIMEタイプであり、改ざん可能です。元の実装では拡張子の検証もしていましたが、この機能が削除されました。

**影響**: 悪意のあるユーザーが拡張子を偽装したファイルをアップロードできる可能性があります。

**修正案**:
```typescript
// 拡張子検証を再度追加
function getFileExtension(fileName: string): string {
  const lastDotIndex = fileName.lastIndexOf('.');
  return lastDotIndex > -1 ? fileName.slice(lastDotIndex + 1).toLowerCase() : '';
}

function validateFileType(mimeType: string, ext: string): boolean {
  const TYPE_TO_EXTENSIONS: Record<string, string[]> = {
    'image/jpeg': ['jpg', 'jpeg'],
    'image/png': ['png'],
  };
  const allowedExts = TYPE_TO_EXTENSIONS[mimeType];
  if (!allowedExts) return false;
  return allowedExts.includes(ext);
}

// validateUpload関数内で、MIMEタイプと拡張子の両方を検証
```

---

### 2. UXの不整合: エラー表示が混在 (中)

**場所**: `src/components/CardManager.tsx:85` と `src/components/CardManager.tsx:229-231`

**問題**: ファイル選択時には `uploadError` ステートを使ってエラーメッセージを表示していますが、フォーム送信時の検証失敗では `alert()` を使用しています。一貫性のないUXです。

**影響**: ユーザー体験が不自然になる

**修正案**:
```typescript
// handleSubmit内のvalidation失敗時
const validation = validateUpload(file);
if (!validation.valid) {
  setUploadError(getUploadErrorMessage(validation.error!, validation.maxSize));
  setSaving(false);
  return;
}
```

---

### 3. file.nameのnull/undefinedチェックがない (中)

**場所**: `src/app/api/upload/route.ts:27`

**問題**: `file.name` をそのまま `.slice()` で処理していますが、File オブジェクトの `name` プロパティが null や undefined の場合の考慮がありません。

**影響**: 稀に `file.name` が空や異常な値の場合にエラーになる可能性がある

**修正案**:
```typescript
const validFile = file as File;
if (!validFile.name || validFile.name.trim() === '') {
  return NextResponse.json({ error: 'ファイル名が空です' }, { status: 400 });
}
const ext = validFile.name.slice(validFile.name.lastIndexOf('.') + 1).toLowerCase();
```

---

### 4. 型の安全性の問題 (低)

**場所**: `src/app/api/upload/route.ts:26`

**問題**: `const validFile = file as File;` の型アサーションを使用しています。 validation を通過しているため安全ですが、将来のコード変更で問題が生じる可能性があります。

**影響**: 軽微 - 現在のロジックでは問題なし

**修正案**:
```typescript
// validation後、fileはnull/undefinedではないことが保証されているため
// 明示的に型を絞り込む
if (!file) {
  return NextResponse.json({ error: 'ファイルが提供されていません' }, { status: 400 });
}
const ext = file.name.slice(file.name.lastIndexOf('.') + 1).toLowerCase();
```

---

## 総評

実装は設計書に従ってられており、基本的な機能は満たされています。しかし、セキュリティ上の問題（拡張子検証の削除）が発見されたため、修正が必要です。

**重要度順の修正依頼**:
1. **高**: MIME тип + 拡張子の両方を検証する（問題1）
2. **中**: エラー表示を統一する（問題2）
3. **中**: file.nameのnullチェックを追加（問題3）

修正後、再レビューを行います。

---

## 設計書レビュー

### 問題なし

設計書（docs/ARCHITECTURE.md Issue #11）は明確で、実装に必要な情報がすべて記載されています。

- 制限値（1MB、JPEG/PNG）は適切
- クライアントサイド・サーバーサイド両方の検証が記載されている
- トレードオフの考慮が適切

---

## チェックリスト

### コード品質
- [ ] TypeScriptの型が適切に使用されている
- [ ] 過度な抽象化がない
- [ ] コードが簡潔である

### セキュリティ
- [ ] ファイルアップロードの検証が十分である
- [ ] MIME type spoofingへの対策がある
- [ ] 拡張子と内容の整合性検証がある

### パフォーマンス
- [ ] 不要な検証処理がない
- [ ] クライアントサイド検証が適切なタイミングで行われている

### UX
- [ ] エラーメッセージが明確である
- [ ] エラー表示が一貫している
