# コードレビュー結果

**レビュー日:** 2026-01-17
**レビュー対象:** `docs/ARCHITECTURE.md`, `docs/IMPLEMENTED.md`, および実装コード

---

## 概要

アーキテクチャおよび実装ドキュメントをレビューしました。全体的な設計は良好でベストプラクティスに従っていますが、QAに進む前に修正が必要な問題が発見されました。

---

## 重大な問題 (Critical Issues)

### #1 EventSub処理にべき等性（Idempotency）がない

**対象ファイル:** `src/app/api/twitch/eventsub/route.ts:67-76`, `src/lib/services/gacha.ts:106-134`

**問題:**
Twitch EventSubは、Webhook配送に失敗した場合に再試行する可能性があります。しかし、現在の実装では同じイベントが複数回到着した場合、ガチャが複数回実行される可能性があります。

**影響:**
- 視聴者が同じ redeemed_at で複数のカードを入手できる
- カードコレクションの整合性が失われる
- ユーザー体験の低下

**推奨修正:**
`gacha_history` テーブルに `event_id` フィールドを追加し、重複チェックを実装してください。

```sql
ALTER TABLE gacha_history ADD COLUMN event_id TEXT UNIQUE;
```

または、アプリケーションレベルで同じ `messageId` のイベントを検出し、2回目以降は処理をスキップするようにしてください。

---

### #2 セッション有効期限が30日と長い

**対象ファイル:** `src/lib/constants.ts:22-25`

**問題:**
```typescript
export const SESSION_CONFIG = {
  MAX_AGE_SECONDS: 60 * 60 * 24 * 30, // 30日間
  // ...
}
```

30日のセッション有効期限はセキュリティ上のリスクとなります。

**影響:**
- セッションCookieが漏洩した場合、攻撃者が30日間アカウントにアクセス可能
- リスクの高い操作（カード削除など）でも再認証が必要ない

**推奨修正:**
以下のいずれかを検討してください：
1. セッション有効期間を7日以下にに変更
2. 重要操作に追加の認証要求を実装
3. Refresh Token 方式の導入

---

## 中程度の問題 (Medium Issues)

### #3 APIレートリミティングが未実装

**対象ファイル:** アーキテクチャ全体

**問題:**
設計書および実装コードにレートリミティングの記述・実装が見つかりません。

**影響:**
- API エンドポイントへのブルートフォース攻撃が可能
- カード作成APIの大量リクエストによるサービス妨害
- ガチャ処理の悪用

**推奨修正:**
以下を検討してください：
1. Upstash Redis を使用したレート制限
2. アプリケーションレベルでの簡易的なレート制限（IP単位）
3. Vercel Middleware での制限

---

### #4 データベース制約の不足

**対象ファイル:** `docs/ARCHITECTURE.md:232-239`

**問題:**
`GACHA_HISTORY` テーブルが TEXT 型の `user_twitch_id` と `user_twitch_username` を使用しており、外部キー制約がありません。

```sql
GACHA_HISTORY {
    TEXT user_twitch_id        -- FKではない
    TEXT user_twitch_username  -- FKではない
}
```

**影響:**
- 視聴者のユーザー名が変わった場合、ガチャ履歴のユーザー名が古くなる
- データ整合性の保証がアプリケーション層に依存

**推奨修正:**
設計書のトレードオフ検討（`docs/ARCHITECTURE.md:321-332`）で「EventSub通知ベース」が選択されていますが、この選択の影響を明確化し、必要に応じて FK 制約の追加を検討してください。

---

## 軽微な問題 / 良好だった点 (Minor Issues / Positive Observations)

### #5 設計と実装の整合性（改善済み）

**ステータス:** ✅ 対応済み

`docs/IMPLEMENTED.md` で報告されていた RLS ポリシーの問題が適切に修正されています。設計書も「カスタムCookie + Twitch OAuth」に更新され、整合性が確保されています。

---

### #6 ドロップ率検証は適切に実装されている

**ステータス:** ✅ 良好

`src/lib/validations.ts` の `validateDropRateSum` 関数により：
- 個別ドロップ率は 0〜1 の範囲内
- 合計ドロップ率は 1.0 以下に制限

---

### #7 Twitch署名検証は適切に実装されている

**ステータス:** ✅ 良好

`src/app/api/twitch/eventsub/route.ts:16-35` で `verifyTwitchSignature` 関数が実装され、`timingSafeEqual` を使用した安全な比較が行われています。

---

### #8 Reward ID 検証は適切に実装されている

**ステータス:** ✅ 良好

`src/lib/services/gacha.ts:126-128` で `reward.id` と `streamer.channel_point_reward_id` の比較が行われています。これにより、誤った Reward によるガチャ実行が防止されています。

---

## デザイン原則の遵守評価

| 原則 | 評価 |
|:---|:---|
| Simple over Complex | ✅ 適切な複雑度 |
| Type Safety | ✅ TypeScript 厳格モード |
| Separation of Concerns | ✅ 機能ごとのモジュール分割 |
| Security First | ⚠️ セッション期間とレート制限を改善推奨 |

---

## 推奨優先度

| 優先度 | 問題 | 必要なアクション |
|:---|:---|:---|
| **High** | #1 EventSubべき等性 | 実装エージェントで修正 |
| **High** | #2 セッション期間 | 実装エージェントで修正 |
| **Medium** | #3 レートリミティング | アーキテクチャ更新で検討 |
| **Low** | #4 データベース制約 | 設計文書の明確化 |

---

## 結論

アーキテクチャは適切に設計され、ベストプラクティスに従っています。しかし、QAに進む前に以下を解決する必要があります：

1. **EventSub処理をべき等にする** - 重複ガチャ実行を防止
2. **セッション期間短縮** - セキュリティリスク窓を最小化

これらの重大な問題が解決されましたら、再レビューを依頼してからQAに進んでください。

---

## 前回のレビューからの改善状況

| 前回の問題 | 状況 |
|:---|:---|
| RLSポリシーが機能しない | ✅ 修正済み |
| 設計と実装の不一致 | ✅ 修正済み |
| ドロップ率0のカード挙動 | ✅ テストで許容される動作として明記 |
| 環境変数の런타임検証 | ✅ 対応済み（実装による） |
| エラーハンドリング | ✅ 対応済み |
| ドロップ率合計の検証 | ✅ アプリケーション層で実装 |
