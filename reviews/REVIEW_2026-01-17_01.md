# コードレビュ結果

**レビュー日:** 2026-01-17
**レビュー対象:** docs/ARCHITECTURE.md, docs/IMPLEMENTED.md, 実装コード

---

## 概要

実装エージェントにフィードバックを行います。複数の問題が発見されました。

---

## 重大な問題

### #1 eventIdがexecuteGachaに渡されていない（べき等性機能が実質無効）

**対象ファイル:** `src/app/api/twitch/eventsub/route.ts:107`

**問題:**
```typescript
// route.ts:107
const result = await gachaService.executeGachaForEventSub(event);
```

`executeGachaForEventSub`に`messageId`（eventId）が渡されていない。

さらに、`src/lib/services/gacha.ts:132`では:
```typescript
return await this.executeGacha(streamer.id, event.user_id, event.user_name, eventId)
```

`eventId`パラメータは`executeGachaForEventSub`の引数として定義されているが、呼び出し元から渡されていないため`undefined`になる。

**結果:** `gacha_history`テーブルに`event_id`が常にNULLで挿入され、べき等性チェックが機能しない。

**修正提案:**
```typescript
// route.ts:73
await handleRedemption(messageId, event);

// route.ts:107
const result = await gachaService.executeGachaForEventSub(event, messageId);
```

```typescript
// gacha.ts:116
async executeGachaForEventSub(
  event: { ... },
  eventId: string  //必須パラメータに変更
): Promise<Result<...>> {
```

---

### #2 重複したgetSupabaseAdmin()呼び出し

**対象ファイル:** `src/app/api/twitch/eventsub/route.ts`

**問題:**
```typescript
// 91行目
const supabaseAdmin = getSupabaseAdmin();
// ... 処理 ...
// 123行目（重複）
const supabaseAdmin = getSupabaseAdmin();  // 不要な再作成
```

**修正提案:**
```typescript
async function handleRedemption(messageId: string, event: { ... }) {
  const supabaseAdmin = getSupabaseAdmin()
  // 91行目の定義を削除し、123行目の重複も削除
  // 既存のsupabaseAdminを使用
```

---

## 設計と実装の不整合

### #3 RLSポリシーがカスタムCookieセッションで機能しない可能性

**対象ファイル:** `supabase/migrations/00001_initial_schema.sql:139-175`

**問題:**
設計書では「アプリケーション層で認証検証 + RLSは多層防御」とあるが、RLSポリシーは`auth.jwt() ->> 'twitch_user_id'`を使用:

```sql
CREATE POLICY "Streamers can update own profile" ON streamers
  FOR UPDATE USING (
    twitch_user_id = auth.jwt() ->> 'twitch_user_id'
  );
```

カスタムCookieを使用している場合、Supabase Auth JWTが存在せず、これらのRLSポリシーは機能しない。

**設計書との整合性:**
- 設計書: 「RLSポリシーを簡素化（auth.jwt()への依存を削除）、アプリケーション層で認証検証」
- 実装: RLSポリシーでまだ`auth.jwt()`を参照している

**修正提案:**
RLSポリシーを削除するか、完全なサービスロール経由のみにすることを検討。

---

## 軽微な問題

### #4 セッション期限切れ後の処理

**対象ファイル:** `src/lib/session.ts:25-28`

**問題:**
```typescript
if (session.expiresAt && Date.now() > session.expiresAt) {
  await clearSession();
  return null;
}
```

セッション期限切れ時にCookieをクリアしているが、HTTPリクエストごとに`getSession()`を呼び出す必要がある。middlewareで検証していないため、期限切れのセッションがAPIルートに到達する可能性がある。

---

### #5 ドロップ率0のカードが選択されない

**対象ファイル:** `src/lib/gacha.ts:9-15`

**問題:**
```typescript
const totalWeightInt = items.reduce((sum, item) => {
  return sum + Math.round((item.drop_rate || 0) * 10000)
}, 0)

if (totalWeightInt === 0) {
  return null  // 全カードがdrop_rate=0の場合null 반환
}
```

全カードのドロップ率が0の場合、ガチャを実行できない。これは仕様通りの動作だが、ドロップ率0のカードが全く選択されない（常にnull）。

**考慮事項:**
- ドロップ率0のカードは「出現しないカード」として機能する
- 実装上は問題ないが、ドロップ率0のカードを登録できる設計인지確認が必要

---

## 確認済み良好点

- ✅ TypeScriptの適切な使用
- ✅ Resultパターンを一貫して使用
- ✅ 環境変数の適切な管理
- ✅ セッション7日間に短縮（セキュリティ向上）
- ✅ Twitch署名検証の実装
- ✅ ファイルアップロードの検証（サイズ、形式）
- ✅ データベースインデックスの適切な設定
- ✅ 設計書の更新履歴が最新状態を反映

---

## テスト結果の確認

実装記録によると:
- ユニットテスト: 28件パス
- Lint: パス
- Type Check: パス
- ビルド: 成功

ただし、上記の問題はテストで発見されていない可能性がある。

---

## 次のアクション

実装エージェントが以下を修正してください:
1. #1: eventIdをexecuteGachaに正しく渡す
2. #2: 重複したgetSupabaseAdmin()呼び出しを削除
3. #3: RLSポリシーの整合性を確認・修正

修正完了後、再レビューを行います。
