# コードレビュー: Issue #13 APIレート制限実装（再々修正レビュー）

## 概要

実装エージェントによるレビュー修正（verifyTwitchSignature強化、JSONパースエラー処理、レート制限バイパス修正）のレビューを実施しました。

---

## 判定

**判定**: ✅ 問題なし - QAエージェントにQA依頼を行います

---

## レビュー項目

### 1. verifyTwitchSignatureのnullチェック強化（route.ts:21-38）

**評価**: ✅ 良好

**確認事項**:
- `!signature` チェックが追加されているか ✅
- try-catch で timingSafeEqual がラップされているか ✅
- secret と signature の両方が null/undefined の場合に false を返すか ✅

**コード確認**:
```typescript
function verifyTwitchSignature(
  messageId: string,
  timestamp: string,
  body: string,
  signature: string
): boolean {
  const secret = process.env.TWITCH_EVENTSUB_SECRET;
  if (!secret || !signature) return false;  // ✅ 追加済み

  const message = messageId + timestamp + body;
  const expectedSignature = "sha256=" + crypto
    .createHmac("sha256", secret)
    .update(message)
    .digest("hex");

  try {
    return crypto.timingSafeEqual(
      Buffer.from(expectedSignature),
      Buffer.from(signature)
    );
  } catch {
    return false;  // ✅ 追加済み
  }
}
```

**評価**: 適切に修正されています。signature が空文字列の場合のクラッシュを防ぎ、timingSafeEqual の例外も安全に処理されています。

---

### 2. JSONパースエラー処理の追加（route.ts:40-48）

**評価**: ✅ 良好

**確認事項**:
- JSON.parse が try-catch でラップされているか ✅
- エラー時に適切なログ出力があるか ✅
- 400 Bad Request を返しているか ✅

**コード確認**:
```typescript
export async function POST(request: NextRequest) {
  const body = await request.text();
  let data;
  try {
    data = JSON.parse(body);
  } catch (e) {
    logger.error("Invalid JSON in request body", { error: e });  // ✅ 追加済み
    return NextResponse.json({ error: "Invalid request body" }, { status: 400 });  // ✅ 追加済み
  }
  // ...
}
```

**評価**: 適切に修正されています。無効なJSONリクエストに対して500エラーではなく400エラーを返すようになり、デバッグも容易です。

---

### 3. 不明なメッセージタイプのレート制限バイパス修正（route.ts:60-78）

**評価**: ✅ 良好

**確認事項**:
- レート制限が `MESSAGE_TYPE_NOTIFICATION` 以外に適用されているか ✅
- 不明なメッセージタイプがレート制限の対象になっているか ✅
- 設計書との整合性 ✅

**コード確認**:
```typescript
if (messageType !== MESSAGE_TYPE_NOTIFICATION) {  // ✅ notification以外を判定
  const ip = getClientIp(request);
  const identifier = `ip:${ip}`;
  const rateLimitResult = await checkRateLimit(rateLimits.eventsub, identifier);
  // ...
}

if (messageType === MESSAGE_TYPE_NOTIFICATION) {
  // notificationはレート制限なし（設計書通り）
  // ...
}

return NextResponse.json({ error: "Unknown message type" }, { status: 400 });
// unknown message typeもレート制限の対象となる
```

**評価**: 適切に修正されています。設計書通り EventSub Webhook は Twitch からの信頼できる通知として notification タイプはレート制限をスキップし、それ以外のタイプ（verification、revocation、unknown）はレート制限の対象となっています。これにより、DoS攻撃のリスクが解消されています。

---

### 4. 軽微な改善提案（オプション）

**項目**: data.challenge の未定義チェック（route.ts:91-95）

**現状**:
```typescript
if (messageType === MESSAGE_TYPE_VERIFICATION) {
  return new NextResponse(data.challenge, {  // data.challenge が undefined の可能性がある
    status: 200,
    headers: { "Content-Type": "text/plain" },
  });
}
```

**提案**（オプション、改善提案）:
```typescript
if (messageType === MESSAGE_TYPE_VERIFICATION) {
  if (!data.challenge) {
    logger.error("Missing challenge in verification message");
    return NextResponse.json({ error: "Invalid verification request" }, { status: 400 });
  }
  return new NextResponse(data.challenge, {
    status: 200,
    headers: { "Content-Type": "text/plain" },
  });
}
```

**評価**: この改善はオプションです。現在の実装でも Twitch から正しいフォーマットでリクエストが来る限り問題はありません。Twitch EventSub は常に challenge を含めるため、実質的なリスクは低いです。

---

### 5. 設計書との整合性確認

**確認事項**:
- ✅ EventSub Webhook は緩いレート制限を持つ（設計書第249項）
- ✅ notification はレート制限をスキップ（設計書第173項、第249項）
- ✅ verification/revocation/unknown はレート制限の対象
- ✅ レート制限ヘッダーが設定される（X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset）

---

### 6. セキュリティ評価

**確認事項**:
- ✅ 不明なメッセージタイプによるレート制限バイパスが修正されている
- ✅ Twitch署名検証の強化（nullチェック、例外処理）
- ✅ JSONパースエラーによる情報漏洩のリスクが軽減
- ✅ 設計書のセキュリティ要件（Issue #57 APIレート制限によるDoS攻撃対策）を満たしている

---

## 総括

実装エージェントによる3つの修正がすべて適切に実装されています。

1. **verifyTwitchSignature の null チェック強化**: signature が空文字列の場合のクラッシュを防ぐ実装がされています
2. **JSON パースエラー処理の追加**: 無効な JSON に対して 400 エラーを返すようになりました
3. **レート制限バイパス修正**: 不明なメッセージタイプもレート制限の対象となり、DoS 攻撃のリスクが解消されました

設計書 docs/ARCHITECTURE.md Issue #13 の要件を満たしており、セキュリティ上の重大な問題は発見されませんでした。

**判定**: ✅ 問題なし

QAエージェントにQA依頼を行い、テストによる動作確認を推奨します。

---

## 参照

- 設計書: `docs/ARCHITECTURE.md`
- 実装記録: `docs/IMPLEMENTED.md`
- コード: `src/lib/rate-limit.ts`, `src/app/api/twitch/eventsub/route.ts`
- 前レビュー: `reviews/REVIEW_2026-01-17_000000.md`
