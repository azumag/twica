# TwiCa Code Review

**Review Date:** 2026-01-17
**Reviewed by:** Code Review Agent
**Architecture Document:** docs/ARCHITECTURE.md

---

## 概要

TwiCaプロジェクトのコードレビューを実施しました。設計書との整合性、コード品質、セキュリティ、パフォーマンスの観点から評価を行いました。

**総合評価:** 要修正あり

---

## 1. 設計書との整合性

### 1.1 ファイルストレージの不一致
**重要度: 低**

設計書では画像ストレージに「Vercel Blob」を使用すると記載されていますが、実装では`src/app/api/upload/route.ts`で`supabase.storage`を使用しています。

**設計書 (docs/ARCHITECTURE.md:283-293):**
> **選択**: Vercel Blob
> **理由**:
> - Vercelとの統合が容易
> - パフォーマンスが良い（CDN配信）

**実際の実装:**
```typescript
// src/app/api/upload/route.ts:38-43
const { data, error } = await supabase.storage
  .from('card-images')
  .upload(fileName, file, {
```

**推奨事項:** 設計書を更新するか、実装をVercel Blobに移行してください。

---

## 2. 重大な問題

### 2.1 データベース制約の欠如
**重要度: 高**

`cards`テーブルに`drop_rate`に対するCHECK制約がありません。以下の問題が発生する可能性があります：

- 負の値（-0.5など）が設定可能
- 1.0を超える値（1.5など）が設定可能
- 単一のカードでdrop_rate > 1.0の場合、ガチャ選択アルゴリズムが正常に動作しない

**現在の検証:**
- APIレベルでは`src/app/api/cards/route.ts:19-23`で0-1の範囲を検証
- データベースレベルでの制約がない

**推奨事項:** SupabaseダッシュボードまたはマイグレーションでCHECK制約を追加してください：
```sql
ALTER TABLE cards ADD CONSTRAINT check_drop_rate CHECK (drop_rate >= 0 AND drop_rate <= 1);
```

### 2.2 カード名の重複チェック缺失
**重要度: 中**

同じ配信者が同じ名前のカードを複数作成できてしまいます。`cards`テーブルに`streamer_id`と`name`の複合UNIQUE制約がありません。

**推奨事項:** データベースに複合UNIQUE制約を追加することを検討してください。

---

## 3. 潜在的なバグとエッジケース

### 3.1 GachaServiceのRace Condition
**重要度: 中**

`src/lib/services/gacha.ts:39-72`の`executeGacha`メソッドで、ガチャ履歴の記録とユーザーコレクションへの追加が別々のデータベース操作として実行されています。

```typescript
// src/lib/services/gacha.ts:40-51
const { error: historyError } = await this.supabase
  .from('gacha_history')
  .insert({...})

// src/lib/services/gacha.ts:54-71
const { data: user } = await this.supabase
  .from('users')
  .select('id')
  .eq('twitch_user_id', userTwitchId)
  .single()

if (user) {
  const { error: collectionError } = await this.supabase
    .from('user_cards')
    .insert({...})
}
```

**問題点:**
- 2つのinsert操作がトランザクションで囲まれていない
- コレクション追加が失敗しても、ガチャ履歴は正常に記録される
- ユーザーがカードを所有しているのに履歴に反映されない可能性

**推奨事項:** Supabaseのトランザクション機能を使用し、両方のinsertをアトミックに実行してください。

### 3.2 ユーザー upsert の重複実行
**重要度: 低**

`executeGachaForEventSub`メソッドで`executeGacha`を呼び出した後、別のupsertを実行しています。これにより、不要なデータベースク리가実行されます。

**src/lib/services/gacha.ts:110-143:**
```typescript
const result = await this.executeGacha(streamer.id, event.user_id, event.user_name)
// ... 上記でusersテーブルをチェック済み ...

// 同じユーザーを再度upsert
const { data: user, error: userError } = await this.supabase
  .from('users')
  .upsert({...})
```

**推奨事項:** `executeGacha`と`executeGachaForEventSub`でユーザーハンドリングを統合し、重複を排除してください。

### 3.3 浮動小数点の精度問題
**重要度: 低**

`src/lib/gacha.ts:9-10`の重み付き選択アルゴリズムで、浮動小数点の精度問題が発生する可能性があります。

```typescript
const totalWeight = items.reduce((sum, item) => sum + (item.drop_rate || 1), 0)
const random = Math.random() * totalWeight
```

**問題点:**
- 浮動小数点の丸め誤差により、`random < cumulative`の判定が不正確になる場合がある
- drop_rateの合計が正確に1.0でない場合、期待外の動作

**推奨事項:** 確率計算には整数ベースの表現（例：drop_rateを10000倍して整数管理）を検討してください。

---

## 4. パフォーマンスに関する問題

### 4.1 データベースクエリの最適化
**重要度: 低**

以下のクエリでインデックスが適切に設定されているか確認が必要です：

- `cards.streamer_id` - カード取得のクエリで使用
- `cards.is_active` - アクティブなカードのみ取得で使用
- `gacha_history.card_id` - カード履歴取得で使用
- `gacha_history.redeemed_at` - 最近の履歴取得で使用

**推奨事項:** Supabaseダッシュボードでクエリパフォーマンスを確認し、必要に応じてインデックスを追加してください。

### 4.2 ページネーションの欠如
**重要度: 中**

`getRecentGachaHistory`関数（`src/lib/dashboard-data.ts:77-90`）で最近の履歴を取得する際、.limit(10)を使用していますが、将来的なスケーラビリティのためページネーションの実装を検討してください。

---

## 5. セキュリティ上の問題

### 5.1 CSRF保護の適切な実装
**重要度: 良好**

認証フローでCSRF保護が適切に実装されています：

- `src/app/api/auth/twitch/login/route.ts`でstateを生成し、クッキーに保存
- `src/app/api/auth/twitch/callback/route.ts`でstateを検証

**実装例:**
```typescript
// src/app/api/auth/twitch/login/route.ts:9-18
const state = crypto.randomUUID()
cookieStore.set('twitch_auth_state', state, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  maxAge: 60 * 10, // 10 minutes
})
```

### 5.2 Twitch署名検証
**重要度: 良好**

EventSub WebhookでTwitch署名が検証されています（`src/app/api/twitch/eventsub/route.ts:16-35`）。

### 5.3 セッション管理の安全性
**重要度: 良好**

セッション cookie に適切なセキュリティ設定が適用されています：

- `httpOnly: true` - XSS攻撃から保護
- `secure: process.env.NODE_ENV === 'production'` - HTTPSでのみ送信
- `sameSite: 'lax'` - CSRF攻撃を軽減
- `maxAge: 60 * 60 * 24 * 30` - 30日間の有効期限

### 5.4 レート制限の欠如
**重要度: 中**

以下のAPIエンドポイントにレート制限がありません：

- `/api/upload` - 画像アップロード
- `/api/gacha` - ガチャ実行
- `/api/cards` - カード管理

**推奨事項:** Vercelのレート制限機能、またはupstash/ratelimitなどのライブラリを検討してください。

---

## 6. コード品質とベストプラクティス

### 6.1 TypeScript型の適切な使用
**重要度: 良好**

データベーススキーマに対応するTypeScript型が適切に定義されています（`src/types/database.ts`）。

### 6.2 エラーハンドリング
**重要度: 良好**

`src/lib/error-handler.ts`で統一されたエラーハンドリングが実装されています。

### 6.3 ログ出力
**重要度: 要改善**

`src/lib/logger.ts`が実装されていますが、以下の改善が必要です：

- 構造化ログ（JSON形式）での出力
- リクエストIDの含め方
- ログレベルの適切な使い分け

**現在の実装:**
```typescript
export const logger = {
  info: (message: string, ...args: unknown[]) => {
    console.log(`[INFO] ${message}`, ...args)
  },
  warn: (message: string, ...args: unknown[]) => {
    console.warn(`[WARN] ${message}`, ...args)
  },
  error: (message: string, ...args: unknown[]) => {
    console.error(`[ERROR] ${message}`, ...args)
  },
}
```

### 6.4 シングルトンパターンの実装
**重要度: 要改善**

`src/lib/supabase/admin.ts`で`getSupabaseAdmin`関数が実装されていますが、Next.jsのサーバーless環境では適切なキャッシュ戦略が必要です。

**現在の実装:**
```typescript
let supabaseAdmin: SupabaseClient | null = null

export function getSupabaseAdmin(): SupabaseClient {
  if (!supabaseAdmin) {
    // ...
    supabaseAdmin = createClient(url, key)
  }
  return supabaseAdmin
}
```

**推奨事項:** グローバル変数はVercelのコールドスタート間で保持されない場合があるため、必要に応じて再初期化ロジックを追加してください。

### 6.5 参照されていないファイル/エクスポートの欠落
**重要度: 低**

TypeScriptのLanguage Serverが`src/app/api/events/[streamerId]/route.ts`という存在しないファイルを参照しようとしてエラーが発生しています。このファイルは削除されたか、参照が古くなっています。

**推奨事項:** この参照の原因を特定し、必要に応じて削除するか、欠落しているファイルを再作成してください。

---

## 7. テスト

### 7.1 ユニットテスト
**重要度: 良好**

`tests/unit/gacha.test.ts`で重み付き選択アルゴリズムのテストが実装されています。

**テスト項目:**
- 空配列の処理
- 単一カードの選択
- 重み付けに基づいた選択
- ゼロ重みアイテムの処理
- 同等確率での選択

### 7.2 テストの追加推奨
**重要度: 中**

以下のテストの追加を検討してください：

- 環境変数検証のテスト
- APIエンドポイントの統合テスト
- 認証フローのテスト
- レート制限のテスト

---

## 8. 推奨される修正事項（優先度順）

### 高優先度
1. データベースに`drop_rate`のCHECK制約を追加
2. `executeGacha`メソッドをトランザクションでラップ
3. レート制限を実装

### 中優先度
4. 設計書を更新（Vercel Blob → Supabase Storage）
5. カード名の重複防止制約を追加
6. `executeGachaForEventSub`のユーザーハンドリングを最適化
7. ページネーションを実装

### 低優先度
8. ログ出力を構造化
9. テストカバレッジを拡大
10. シングルトンパターンを改善

---

## 9. 総括

TwiCaプロジェクトは、全体的に хорошо（ хорошо = 良い）実装されています。認証・認可、セキュリティ、TypeScriptの型安全性など、多くの点で適切な実装が見られます。

一方で、データベースレベルの制約缺失、一部のRace Conditionの可能性、レート制限の欠如など、本番環境での安定性に影響する可能性のある問題が発見されました。

実装エージェントにフィードバックを行い、高優先度の修正事宜を検討・実装することを推奨します。

---

## チェックリスト

### 機能要件
- [x] Twitch OAuth認証
- [x] Supabase Auth統合
- [x] カード管理機能
- [x] ガチャ機能
- [x] オーバーレイ表示
- [x] ダッシュボード

### 非機能要件
- [x] TypeScriptによる型安全性
- [x] RLSによるデータアクセス制御
- [x] CSRF対策
- [x] XSS対策（Reactの自動エスケープ）
- [ ] レート制限（未実装）
- [ ] データベース制約（一部未実装）

### コード品質
- [x] 一貫したコーディングスタイル
- [x] 適切なエラーハンドリング
- [x] 環境変数の検証
- [ ] ログの構造化（要改善）
- [ ] テストカバレッジ（拡張推奨）
