# TwiCa Code Review

**Review Date:** 2026-01-17
**Reviewer:** Code Review Agent

---

## 概要

設計書（docs/ARCHITECTURE.md）と実装コード进行全面的にレビューしました。実装はOverall得很好で、アーキテクチャ設計に沿った実装が行われています。しかし、セキュリティ、パフォーマンス、および堅牢性に関するいくつかの重要な問題が発見されました。

---

## 重要度別問題一覧

### 🔴 高優先度（セキュリティ関連）

#### 1. ガチャAPIの認証バイパス（`src/app/api/gacha/route.ts:14`）

**問題:** `/api/gacha` エンドポイントがリクエストBodyから任意の `userTwitchId` と `userTwitchUsername` を受け付けています。これにより、認証済みユーザーが他の視聴者になりすましてガチャを引くことが可能になります。

**現在のコード:**
```typescript
const body = await request.json();
const { streamerId, userTwitchId, userTwitchUsername } = body;
```

**推奨修正:**
- リクエストBodyから `userTwitchId` と `userTwitchUsername` を削除
- セッションから認証済みユーザーの情報を取得
- または、EventSub経由のガチャのみを許可し、API経由のガチャを削除/管理者専用にする

---

#### 2. セッションCookieの暗号化不足（`src/lib/session.ts:22`）

**問題:** セッション情報が平文のJSONでCookieに保存されています。セッションにはユーザーのTwitch ID、用户名、表示名が含まれており、攻撃者に悪用される可能性があります。

**現在のコード:**
```typescript
const session = JSON.parse(sessionCookie) as Session
```

**推奨修正:**
- Supabase Authの標準的なJWTトークンを使用する
- または、セッション情報を暗号化して保存

---

#### 3. SSE接続のメモリ内ストレージ（`src/app/api/twitch/eventsub/route.ts:15`）

**問題:** `sseConnections` がメモリ内のMapに保存されています。VercelのServerless環境では、複数のインスタンス間で接続が共有されず、またインスタンスの再起動時に接続が失われます。

**現在のコード:**
```typescript
const sseConnections = new Map<string, Set<ReadableStreamDefaultController>>();
```

**推奨修正:**
- 本番環境ではRedis（Upstash、Redis Labsなど）を使用
- または、Supabase Realtimeを使用することを検討

---

### 🟡 中優先度（堅牢性・データ整合性）

#### 4. ドロップ率検証のrace condition（`src/lib/validations.ts`）

**問題:** ドロップ率の合計検証と実際のカード登録が別々のトランザクションで実行されています。複数のリクエストが同時に処理された場合、ドロップ率の合計が1.0を超えてしまう可能性があります。

**推奨修正:**
- データベースのCHECK制約を使用して、ドロップ率合計が1.0以下であることを保証
- SupabaseのSQL関数を使用してアトミックな更新を実装

---

#### 5. カード所有者検証の脆弱性（`src/app/api/cards/[id]/route.ts:32-42`）

**問題:** カード所有者の検証に`streamers!inner(twitch_user_id)`のJOINを使用していますが、型安全でないキャスト (`as any`) が使用されています。

**現在のコード:**
```typescript
const streamers = card?.streamers as any;
const twitchUserId = Array.isArray(streamers) ? streamers[0]?.twitch_user_id : streamers?.twitch_user_id;
```

**推奨修正:**
- Supabaseの型定義を正しく使用
- 別クエリで所有者を検証することを検討

---

#### 6. エラーハンドリングによる情報漏洩（`src/lib/error-handler.ts`）

**問題:** `handleApiError`と`handleDatabaseError`は、詳細なエラー情報をロガーに出力しますが、クライアントには "Internal server error" のみを返します。これは良い実践ですが、改善の余地があります。

**現在のコード:**
```typescript
export function handleApiError(error: unknown, context: string): Response {
  logger.error(`${context}:`, error)
  return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
}
```

**推奨修正:**
- エラーIDを生成してクライアントに返し、サーバー側で詳細を correlate できるようにする

---

### 🟢 低優先度（コード品質・ベストプラクティス）

#### 7. 重複したファイル（`src/lib/gacha.ts` と `src/lib/services/gacha.ts`）

**問題:** `selectWeightedCard`関数が `src/lib/gacha.ts` に定義されていますが、`src/lib/services/gacha.ts` も同じロジックをインポートして使用しています。これは意図的な分離ですが、维护性向上のためコメントを追加することを推奨します。

---

#### 8. 入力検証の不足（複数ファイル）

**問題:** カード登録/更新APIで、以下のフィールドが検証されていません:
- `name`: 最大長の制限がない
- `description`: 最大長の制限がない
- `imageUrl`: URL形式の検証がない
- `rarity`: 列挙値の検証がない

**推奨修正:**
- Zodなどのバリデーションライブラリを導入
- または、手動で検証ロジックを追加

---

#### 9. セッションエラーハンドリング（`src/lib/session.ts:24-26`）

**問題:** JSONパースエラーは記録されますが、ユーザーは単にnullセッションを受け取ります。攻撃者が悪意のあるCookieを設定した場合の挙動が不明確です。

**現在のコード:**
```typescript
} catch (error) {
  logger.error('[Session] Failed to parse session cookie:', error);
  return null
}
```

---

#### 10. SSE接続のメモリリーク可能性（`src/app/api/twitch/eventsub/route.ts:33-38`）

**問題:** `notifySSEClients`で接続エラーが発生した場合、`connections.delete(controller)`が実行されますが、正常な接続の削除には`removeSSEConnection`関数を使用するべきです。

**現在のコード:**
```typescript
connections.forEach((controller) => {
  try {
    controller.enqueue(new TextEncoder().encode(message));
  } catch {
    connections.delete(controller);  // 関数を使用すべき
  }
});
```

---

## 肯定的な点

1. **TypeScriptの適切な使用**: 型定義が很好に設計されており、`Database`型がSupabaseテーブル構造を正確に反映しています。

2. **Result型の採用**: `src/types/result.ts` で Resultパターンを使用しており、エラーハンドリングが一貫しています。

3. **環境変数の検証**: `src/lib/env-validation.ts` で必須環境変数の検証が行われています。

4. **ログ記録**: `src/lib/logger.ts` で構造化されたロギングが実装されています。

5. **テストの存在**: `tests/unit/gacha.test.ts` があり、ガチャロジックのテストが coverage されています。

6. **セキュリティ対策**:
   - CSRF対策（SameSite=Lax Cookie）
   - Twitch署名の検証
   - セッションのhttpOnlyフラグ

7. **ファイルアップロードの検証**: ファイルサイズとMIMEタイプの検証が実施されています。

---

## 推奨アクション

### 即座に修正すべき（本次リリース）
1. ** гача APIの認証問題** を修正
2. SSE接続にRedisを使用するよう修正（またはSupabase Realtimeに移行）
3. セッション情報を暗号化する、またはSupabase AuthのJWTを使用

### 次のリリースで修正すべき
4. ドロップ率のデータベースCHECK制約を追加
5. 入力バリデーションを強化（Zodの導入を検討）
6. エラー処理の改善（エラーIDの correlate）

---

## 結論

実装Overall得很好で、アーキテクチャ設計に沿った実装が行われています。しかし、セキュリティに関する重大な問題（ гача APIの認証バイパス、SSE接続のメモリ内ストレージ）が発見されました。これらを修正しないまま、本番環境にデプロイすることは推奨できません。

修正後、QAテストを実施することを推奨します。
