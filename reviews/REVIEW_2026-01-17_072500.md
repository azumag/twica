# コードレビュー: Issue #13 APIレート制限実装

## 概要

実装エージェントによるIssue #13（APIレート制限）の実装をレビューしました。**重大な問題が発見されたため、修正が必要です。**

---

## 重大な問題 (Critical Issues)

### 1. EventSub Webhookのレート制限が無効にされていない

**場所**: `src/app/api/twitch/eventsub/route.ts`

**問題**: アーキテクチャ文書（行173）によると、EventSub WebhookはTwitchからの信頼できる通知であるため、レスキップする必要があります。しかし、現実装ート制限チェックをではIPベースのレート制限が適用されています。

**影響**:
- Twitchの公式サーバーでもレート制限に抵触する可能性
- 配信者が同時に多くの視聴者ポイント還元を行った場合、EventSub通知がブロックされる

**修正案**:
```typescript
// eventsub route.ts の先頭でレート制限をスキップ
if (messageType === MESSAGE_TYPE_NOTIFICATION) {
  // EventSubは信頼できるため、レート制限をスキップ
  // 既存の処理...
}
```

---

### 2. メモリリークの可能性

**場所**: `src/lib/rate-limit.ts:12`

**問題**: `memoryStore` Mapは決してクリーンアップされません。Serverless環境では、長時間稼働するとメモリ使用量が無制限に増加します。

**影響**: メモリ不足によるクラッシュ

**修正案**:
```typescript
const memoryStore = new Map<string, { count: number; resetTime: number }>();

// クリーンアップ処理を追加
setInterval(() => {
  const now = Date.now();
  for (const [key, record] of memoryStore.entries()) {
    if (now > record.resetTime) {
      memoryStore.delete(key);
    }
  }
}, 60 * 1000); // 1分ごとにクリーンアップ
```

---

### 3. 型の安全性の問題

**場所**: `src/lib/rate-limit.ts:23-41`

**問題**: `as unknown as Ratelimit` の型アサーションが使用されています。これは型の安全性を損ない、保守性を低下させます。

**修正案**: 適切なインターフェースを定義するか、アップスタートの公式メモリストレージを使用してください。

---

### 4. race condition（競合状態）

**場所**: `src/lib/rate-limit.ts:28-38`

**問題**: メモリストアの実装が非同期操作中に競合状態を起こす可能性があります。複数のリクエストが同時に同じidentifierで処理された場合、カウントが正しく更新されない可能性があります。

**修正案**:
```typescript
// Mapの代わりにAsyncMutexを使用するか、Redisを使用することを推奨
```

---

## 中程度の問題 (Medium Issues)

### 5. PUT/DELETEメソッドの区別がない

**場所**: `src/app/api/cards/[id]/route.ts`

**問題**: `cardsId` レート制限がPUTとDELETEの両方に使用されていますが、本来PUT（更新）とDELETE（削除）は異なる操作としてレート制限すべきです。

**現在の設計**: 設計書では `/api/cards/[id]` に対して100リクエスト/分の制限がありますが、HTTPメソッドの区別が明記されていません。

**提案**: 設計書の更新を検討してください。

---

### 6. レート制限の適用順序

**問題**: 一部のAPIルートで、セッション確認の前にレート制限をチェックしています。これにより、未認証ユーザーのみがレート制限の影響を受けます。

**現在の実装**:
```typescript
// upload route.ts
const session = await getSession();
const identifier = await getRateLimitIdentifier(request, session?.twitchUserId);
```

**問題点**: `getSession()` がエラーを投げた場合、レート制限が適切に機能しない可能性があります。

---

## 小さな問題 (Minor Issues)

### 7. 環境変数の検証がない

**場所**: `src/lib/rate-limit.ts:5-10`

**問題**: `UPSTASH_REDIS_REST_TOKEN!` で非nullアサーションを使用していますが、環境変数が設定されていない場合の検証がありません。

---

### 8.  документаとの不整合

**問題**: 設計書では429エラー時に `retryAfter` を返すと記載されていますが、一部のAPIではこのフィールドが省略されています。

**実装**: upload, cards, gacha, settings APIsでは `retryAfter` を返していますが、auth APIsでは返していません。

---

## セキュリティ上の考慮事項

### 良い点
- IPアドレスの取得時に複数のヘッダーをチェックしている
- フェイルセーフ（エラー時は許可）
- X-RateLimit-* ヘッダーの適切な設定

### 懸念点
- `x-forwarded-for` ヘッダーは偽装可能であり、IPベースのレート制限は完全な対策ではありません
- 設計書で言及されているグローバルレート制限（middleware.ts）が実装されていない

---

## 推奨される修正優先順位

1. **高**: EventSub Webhookのレート制限スキップ
2. **高**: メモリリーク対策
3. **中**: race condition の修正（Redis使用を推奨）
4. **中**: 型の安全性の改善
5. **低**: 環境変数の検証追加

---

## 総括

実装は基本的なレート制限機能を実装していますが、以下の点で設計書との不整合と重大な問題が発見されました：

1. **EventSub Webhookのレート制限処理** - 設計書で明記された要件が満たされていない
2. **メモリリーク** - 長期稼働時の安定性に影響
3. **型の安全性** - 保守性の問題

**判定**: ❌ 修正が必要 - 実装エージェントにフィードバックを行ってください。

---

## 参照

- 設計書: `docs/ARCHITECTURE.md`
- 実装記録: `docs/IMPLEMENTED.md`
- コード: `src/lib/rate-limit.ts`
