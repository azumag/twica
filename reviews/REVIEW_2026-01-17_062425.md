# コードレビュ結果

**レビュー日:** 2026-01-17
**レビュー対象:** docs/ARCHITECTURE.md, docs/IMPLEMENTED.md, 実装コード

---

## 概要

前回レビューで発見された3つの問題（#1, #2, #3）はすべて修正されています。

新たに発見された問題を報告します。

---

## 重大な問題

### #1 RLSポリシーの重複定義

**対象ファイル:** `supabase/migrations/00001_initial_schema.sql`

**問題:**
RLSポリシーが複数回重複して定義されています。

```sql
-- 1回目の定義（Lines 123-125）
CREATE POLICY "Service can insert gacha history" ON gacha_history
  FOR INSERT WITH CHECK (true);

-- 2回目の定義（Lines 159-160）- 重複
CREATE POLICY "Service can insert gacha history" ON gacha_history
  FOR INSERT WITH CHECK (true);

-- Lines 111-117 にも重複
CREATE POLICY "Cards are viewable by everyone" ON cards
  FOR SELECT USING (is_active = true);

CREATE POLICY "Active streamers are viewable by everyone" ON streamers
  FOR SELECT USING (is_active = true);

-- Lines 132-134 にも同じ定義 - 重複
CREATE POLICY "Active streamers are viewable by everyone" ON streamers
  FOR SELECT USING (is_active = true);
```

**影響:**
- ポリシーの管理が複雑化
- 将来的な変更時に不整合が発生する可能性
- PostgreSQLは重複ポリシーを許容するが、ベストプラクティスに反する

**修正提案:**
重複しているポリシー定義を削除し、一箇所に統合してください。

---

### #2 EventSubべき等性チェックの競合状態

**対象ファイル:** `src/app/api/twitch/eventsub/route.ts:93-103`

**問題:**
べき等性チェックとINSERTがアトミックではありません。

```typescript
// チェック（別トランザクション）
const { data: existingHistory } = await supabaseAdmin
  .from('gacha_history')
  .select('id')
  .eq('event_id', messageId)
  .single();

if (existingHistory) {
  return;  // 重複スキップ
}

// ここでもしも別のリクエストが同じevent_idでINSERTすると、
// 一意制約違反エラーになる可能性がある
const result = await gachaService.executeGachaForEventSub(event, messageId);
```

**影響:**
- 同時に複数の同じEventSubメッセージが届いた場合、一意制約違反エラーになる可能性がある
- `gacha_history.event_id`には`UNIQUE`制約があるため、INSERT時にエラーが発生

**修正提案:**
`ON CONFLICT DO NOTHING`を使用して、競合発生時にエラーを回避してください:

```typescript
// gacha_historyのupsertを使用
await this.supabase
  .from('gacha_history')
  .upsert({
    event_id: eventId || null,
    // ...
  }, {
    onConflict: 'event_id',
    ignoreDuplicates: true,
  })
```

---

## 設計書と実装の不整合

### #3 セッション有効期限の不一致

**対象ファイル:** `docs/ARCHITECTURE.md:387`

**設計書の記載:**
> カスタムCookieによるセッション管理（**30日**有効期限）

**実装:** `src/app/api/auth/twitch/callback/route.ts:72`
```typescript
const SESSION_DURATION = 7 * 24 * 60 * 60 * 1000; // 7日間
```

**問題:**
設計書では30日と記載されていますが、実装では7日間になっています。

**修正提案:**
設計書を7日に更新するか、実装を30日に変更してください。
（セキュリティ観点から7日の方が適切だと思います）

---

## 軽微な問題

### #4 ファイルアップロードの拡張子検証バイパス可能性

**対象ファイル:** `src/app/api/upload/route.ts:38-41`

**問題:**
```typescript
const ext = getFileExtension(file.name);
if (!ALLOWED_EXTENSIONS.includes(ext)) {
  return NextResponse.json({ error: '許可されていないファイル形式です' }, { status: 400 });
}
```

ファイル拡張子の検証のみで、MIMEタイプと拡張子の整合性を確認していません。

**影響:**
攻撃者が拡張子を偽装した悪意のあるファイルをアップロードする可能性（限定的）

**修正提案:**
```typescript
const expectedMimeType = ALLOWED_TYPES.find(t => {
  const exts = {
    'image/jpeg': ['jpg', 'jpeg'],
    'image/png': ['png'],
    'image/gif': ['gif'],
    'image/webp': ['webp'],
  }
  return exts[t]?.includes(ext)
});

if (!expectedMimeType || file.type !== expectedMimeType) {
  return NextResponse.json({ error: 'ファイル形式が一致しません' }, { status: 400 });
}
```

---

### #5 ランダム数の精度問題

**対象ファイル:** `src/lib/gacha.ts:17`

**問題:**
```typescript
const random = Math.floor(Math.random() * totalWeightInt)
```

`Math.random()`は暗号学的に安全ではありません。厳密には問題ありませんが、ガチャシステムでは公平性への懸念を招く可能性があります。

**影響:**
極めて限定的 - 実用上の問題はありません

**代替案（オプション）:**
```typescript
const random = BigInt("0x" + crypto.randomUUID().replace(/-/g, "")) % BigInt(totalWeightInt)
```

---

## 確認済み良好点

- ✅ TypeScriptの適切な使用
- ✅ Resultパターンを一貫して使用
- ✅ 環境変数の適切な管理
- ✅ Twitch署名検証の実装
- ✅ ファイルアップロードの検証（サイズ、形式）
- ✅ データベースインデックスの適切な設定
- ✅ 前回レビューの問題（#1, #2, #3）がすべて修正されている
- ✅ RLSポリシーが`auth.jwt()`への依存を削除されている
- ✅ ドロップ率検証（validateDropRateSum）の実装
- ✅ セッション期限切れ後の適切な処理
- ✅ エラーハンドラーの実装

---

## テスト結果の確認

実装記録によると:
- ユニットテスト: 28件パス
- Lint: パス
- Type Check: パス
- ビルド: 成功

---

## 次のアクション

実装エージェントが以下を修正してください:
1. **#1**: RLSポリシーの重複を削除し、、ポリシーを整理する
2. **#2**: EventSubべき等性チェックのアトミック性を確保する
3. **#3**: 設計書のセッション有効期限を7日に更新する（または実装を30日に変更）
4. **#4**: ファイルアップロードの検証を強化する（オプション）

修正完了後、再レビューを行います。

