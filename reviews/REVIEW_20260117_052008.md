# TwiCa Code Review

**Review Date:** 2026-01-17 12:15:00 JST
**Reviewed by:** Code Review Agent
**Architecture Document:** docs/ARCHITECTURE.md

---

## 概要

TwiCaプロジェクトのコードレビューを実施しました。設計書との整合性、コード品質、セキュリティ、パフォーマンスの観点から評価を行いました。

**総合評価:** 要修正あり

多数の重大な問題と軽微な問題が発見されました。実装エージェントによる修正が必要です。

---

## 1. 設計書との整合性

### 1.1 ファイルストレージの不一致
**重要度: 低**

設計書では画像ストレージに「Vercel Blob」を使用すると記載されていますが、実装では`src/app/api/upload/route.ts`で`supabase.storage`を使用しています。

**実際の実装:**
```typescript
// src/app/api/upload/route.ts:38-43
const { data, error } = await supabase.storage
  .from('card-images')
  .upload(fileName, file, {
```

**推奨事項:** 設計書を更新してください。

---

## 2. 重大な問題

### 2.1 セッション Cookie 名称の不一致
**重要度: 高**

`src/lib/session.ts`と`src/app/api/auth/twitch/callback/route.ts`間でCookie名の定義が異なっています。

**src/lib/session.ts:12:**
```typescript
export const COOKIE_NAMES = {
  SESSION: 'twica_session',
  AUTH_STATE: 'twitch_auth_state',
}
```

**src/app/api/auth/twitch/callback/route.ts:79:**
```typescript
cookieStore.set('twica_session', sessionData, {
```

一貫性を保つため、定数を使用してください。

### 2.2 GachaServiceの重複したユーザーハンドリング
**重要度: 高**

`executeGacha`と`executeGachaForEventSub`の両方でユーザーデータ베이스操作が行われており、冗長で注意が必要です。

**src/lib/services/gacha.ts:54-71 (executeGacha):**
```typescript
const { data: user } = await this.supabase
  .from('users')
  .select('id')
  .eq('twitch_user_id', userTwitchId)
  .single()

if (user) {
  const { error: collectionError } = await this.supabase
    .from('user_cards')
    .insert({...})
}
```

**src/lib/services/gacha.ts:117-143 (executeGachaForEventSub):**
```typescript
const result = await this.executeGacha(streamer.id, event.user_id, event.user_name)
// ... executeGacha already handles user collection ...

// Then does another upsert and insert
const { data: user, error: userError } = await this.supabase
  .from('users')
  .upsert({...})

const { error: collectionError } = await this.supabase
  .from('user_cards')
  .insert({...})
```

**問題点:**
- `executeGacha`内でユーザーとコレクションを追加しようとする
- `executeGachaForEventSub`内で再度upsertとinsertを実行
- 重複插入の可能性

**推奨事項:** `executeGachaForEventSub`の重複ロジックを削除し、`executeGacha`に処理を委譲してください。

### 2.3 カードAPIの所有権検証缺失
**重要度: 高**

`src/app/api/cards/route.ts`のGETエンドポイントでは、streamerIdパラメータを受け取るのみで、配信者としての所有権検証が行われていません。

**src/app/api/cards/route.ts:76-98:**
```typescript
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const streamerId = searchParams.get("streamerId");

  if (!streamerId) {
    return NextResponse.json({ error: "Missing streamerId" }, { status: 400 });
  }

  const supabaseAdmin = getSupabaseAdmin();
  const { data: cards, error } = await supabaseAdmin
    .from("cards")
    .select("*")
    .eq("streamer_id", streamerId)
    .eq("is_active", true)
    .order("created_at", { ascending: false });
```

**問題点:**
- 任意のユーザーが任意の関係者のカード情報を取得可能
- プライバシー上の問題

**推奨事項:** 所有者確認ロジックを追加するか、公開データとして明示的に設計してください。

---

## 3. 潜在的なバグとエッジケース

### 3.1 selectWeightedCardのゼロ重み処理
**重要度: 中**

全てのカードが`drop_rate = 0`の場合、最後のカードが返されます。これは数学的に不適切です。

**src/lib/gacha.ts:6-21:**
```typescript
export function selectWeightedCard<T extends WeightedCard>(items: T[]): T | null {
  if (items.length === 0) return null

  const totalWeight = items.reduce((sum, item) => sum + (item.drop_rate || 1), 0)
  const random = Math.random() * totalWeight
  let cumulative = 0

  for (const item of items) {
    cumulative += item.drop_rate || 1
    if (random < cumulative) {
      return item
    }
  }

  return items[items.length - 1] // 全ての重みが0の場合、ここに到達
}
```

**問題点:**
- 全カードのdrop_rateが0の場合、`totalWeight = 0`となり、`random = 0`
- ループ内で`cumulative`も常に0
- 結果として最後のカードを返す（確率的根拠なし）

**推奨事項:** `totalWeight === 0`の場合、nullを返すか、エラーをスローしてください。

### 3.2 画像アップロードのファイル名処理
**重要度: 中**

`src/app/api/upload/route.ts`でファイル拡張子の抽出に`split('.').pop()`を使用していますが、ファイル名に複数のドットが含まれている場合、意図しない動作をする可能性があります。

**src/app/api/upload/route.ts:35:**
```typescript
const ext = file.name.split('.').pop();
```

**例:** `my.card.image.png` → `png`（正しい）
**例:** `my.file.` → 空文字

**推奨事項:** より堅牢な拡張子抽出ロジックを使用してください。

### 3.3 CardManagerのImageコンポーネントprops
**重要度: 低**

`src/components/CardManager.tsx`のImageコンポーネントに不適切なwidth/height値が設定されています。

**src/components/CardManager.tsx:305-311:**
```typescript
<Image
  src={card.image_url || "/placeholder.png"}
  alt={card.name}
  width={200}
  height={200}
  className="w-full h-48 object-cover rounded mb-2"
/>
```

**問題点:**
- `width={200} height={200}`と`className="w-full h-48"`が競合
- 意図しない画像スケーリングの可能性

**推奨事項:** width/heightを削除し、classNameのみに依存するか、適切な値を設定してください。

---

## 4. セキュリティ上の問題

### 4.1 レート制限の欠如
**重要度: 中**

以下のAPIエンドポイントにレート制限がありません：

- `/api/upload` - 画像アップロード
- `/api/gacha` - ガチャ実行
- `/api/cards` - カード管理
- `/api/twitch/eventsub` - EventSub Webhook

**推奨事項:** Vercelのレート制限機能、またはupstash/ratelimitなどのライブラリを検討してください。

### 4.2 Middlewareでのセッション検証缺失
**重要度: 中**

`src/middleware.ts`ではセッションの存在を検証していません。

**src/middleware.ts:4-6:**
```typescript
export async function middleware(request: NextRequest) {
  return await updateSession(request)
}
```

`updateSession`はSupabaseセッションを更新するだけで、アプリケーションレベルのセッション（`twica_session` cookie）は検証されていません。

**推奨事項:** 重要なルートに対しては、明示的なセッション検証を追加してください。

### 4.3 Realtime接続の状態確認缺失
**重要度: 低**

`src/lib/realtime.ts`の`subscribeToGachaResults`関数では、チャンネル接続の状態を確認していません。

**src/lib/realtime.ts:39-54:**
```typescript
export function subscribeToGachaResults(
  streamerId: string,
  callback: (payload: GachaBroadcastPayload) => void
): () => void {
  const channel = supabaseRealtime.channel(`gacha:${streamerId}`)
  
  channel
    .on('broadcast', { event: 'gacha_result' }, (payload) => {
      callback(payload.payload as GachaBroadcastPayload)
    })
    .subscribe()

  return () => {
    supabaseRealtime.removeChannel(channel)
  }
}
```

**問題点:**
- `subscribe()`の接続ステータスを確認していない
- 接続失敗時にエラーが報告されない

**推奨事項:** 接続状態を確認し、必要に応じてエラーハンドリングを追加してください。

---

## 5. コード品質とベストプラクティス

### 5.1 eslint-disable-next-lineコメントの乱用
**重要度: 低**

複数のファイルで不必要な`eslint-disable-next-line`コメントが使用されています：

**src/app/api/cards/[id]/route.ts:38, 107:**
```typescript
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const streamers = card?.streamers as any;
```

**src/app/api/twitch/eventsub/route.ts:26:**
```typescript
// eslint-disable-next-line @typescript-eslint/no-explicit-any
```

**推奨事項:** 適切な型定義を使用して、これらのコメントを削除してください。

### 5.2 データベースエラーハンドリングの改善
**重要度: 低**

`.single()`使用時のエラー処理が一貫していません。

**src/lib/services/gacha.ts:54-58:**
```typescript
const { data: user } = await this.supabase
  .from('users')
  .select('id')
  .eq('twitch_user_id', userTwitchId)
  .single()
```

`.single()`は対象が見つからない場合にエラーを返します。エラーの種類を確認し、適切に処理してください。

### 5.3 環境変数の遅延検証
**重要度: 低**

`src/lib/env-validation.ts:44-47`でモジュール読み込み時に環境変数を検証していますが、`NODE_ENV !== 'test'`の条件が不完全です（`development`環境では検証されません）。

```typescript
if (!valid && process.env.NODE_ENV !== 'test') {
  throw new Error(...)
}
```

**推奨事項:** `development`環境でも検証することをお勧めします。

---

## 6. テスト

### 6.1 既存のテストの品質
**重要度: 良好**

`tests/unit/gacha.test.ts`で重み付き選択アルゴリズムのテストが適切に実装されています。

### 6.2 不足しているテスト
**重要度: 中**

以下のテストの追加を検討してください：

- APIエラーハンドリングのテスト
- 認証フローのテスト
- ファイルアップロードのテスト
- Realtime接続のテスト

---

## 7. 推奨される修正事項（優先度順）

### 高優先度
1. セッションCookie名の定数使用への統一
2. GachaServiceの重複ロジックを削除
3. カードAPI GETエンドポイントに所有者検証を追加
4. selectWeightedCardのゼロ重みケースを修正

### 中優先度
5. レート制限を実装
6. ファイル拡張子抽出ロジックを改善
7. Middlewareにセッション検証を追加
8. eslint-disable-next-lineコメントを削除

### 低優先度
9. CardManagerのImageコンポーネントpropsを修正
10. Realtime接続の状態確認を追加
11. テストカバレッジを拡大

---

## 8. 総括

TwiCaプロジェクトは基本的なアーキテクチャが適切に設計されていますが、以下の問題が発見されました：

1. **データ整合性:** カードAPIの所有権検証缺失
2. **コードの冗長性:** GachaServiceでの重複したユーザーハンドリング
3. **セキュリティ:** レート制限の欠如
4. **堅牢性:** selectWeightedCardのエッジケース処理

実装エージェントにフィードバックを行い、高優先度の修正事宜を検討・実装することを依頼します。

---

## チェックリスト

### 設計書との整合性
- [x] アーキテクチャパターンの実装
- [ ] ストレージ選定の一貫性（要設計書更新）

### セキュリティ
- [x] Twitch OAuth認証
- [x] CSRF対策
- [x] 署名検証
- [ ] レート制限（未実装）
- [ ] セッション検証（要強化）

### コード品質
- [x] TypeScript型安全性
- [x] 環境変数検証
- [ ] 定数の使用（一部未使用）
- [ ] eslintコメントの整理（要削除）

### 機能
- [x] カード管理機能
- [x] ガチャ機能
- [x] オーバーレイ表示
- [ ] カード所有者検証（未実装）
