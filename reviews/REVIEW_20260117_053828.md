# TwiCa Code Review

**Review Date:** 2026-01-17 05:20:08 JST
**Reviewed by:** Code Review Agent
**Architecture Document:** docs/ARCHITECTURE.md

---

## 概要

TwiCaプロジェクトのコードレビューを実施しました。前回レビューからの修正状況、新しく発見された問題、および現在のコード品質を評価しました。

**総合評価:** 良好（大多数の問題が修正済み）

、前回指摘された問題が多くが修正されており、コードベースは改善されています。軽微な問題がいくつか残っていますが、重大な問題は残りません。

---

## 1. 前回レビューからの修正状況

### 1.1 修正済み

#### GachaServiceの重複したユーザーハンドリング ✅ 修正済
`src/lib/services/gacha.ts`で`executeGachaForEventSub`が`executeGacha`を呼び出す形になり、重複ロジックが削除されました。

**変更前（問題）:**
```typescript
// executeGachaForEventSub内で重複したユーザーハンドリング
const { data: user, error: userError } = await this.supabase
  .from('users').upsert({...})
const { error: collectionError } = await this.supabase
  .from('user_cards').insert({...})
```

**変更後（解決）:**
```typescript
// executeGachaForEventSubはexecuteGachaに処理を委譲
return await this.executeGacha(streamer.id, event.user_id, event.user_name)
```

#### カードAPIの所有権検証 ✅ 修正済
`src/app/api/cards/route.ts`のGETエンドポイントに所有者検証が追加されました。

**変更後:**
```typescript
export async function GET(request: NextRequest) {
  const session = await getSession();
  const { searchParams } = new URL(request.url);
  const streamerId = searchParams.get("streamerId");

  if (!streamerId) {
    return NextResponse.json({ error: "Missing streamerId" }, { status: 400 });
  }

  const supabaseAdmin = getSupabaseAdmin();
  const { data: streamer, error: streamerError } = await supabaseAdmin
    .from("streamers")
    .select("id")
    .eq("id", streamerId)
    .eq("twitch_user_id", session?.twitchUserId)  // 所有者検証追加
    .single();

  if (streamerError || !streamer) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }
  // ...
}
```

#### selectWeightedCardのゼロ重み処理 ✅ 修正済
`src/lib/gacha.ts`で`totalWeight === 0`の場合にnullを返すようになりました。

**変更後:**
```typescript
export function selectWeightedCard<T extends WeightedCard>(items: T[]): T | null {
  if (items.length === 0) return null

  const totalWeight = items.reduce((sum, item) => sum + (item.drop_rate || 1), 0)

  if (totalWeight === 0) {  // ゼロ重みのケースを処理
    return null
  }
  // ...
}
```

---

## 2. 仍未修正の問題

### 2.1 セッションCookie名の不一致
**重要度: 低**

`src/app/api/auth/twitch/callback/route.ts`でセッションCookie名にハードコードされた`'twica_session'`が使用されています。定数`COOKIE_NAMES.SESSION`を使用すべきです。

**問題箇所** (`src/app/api/auth/twitch/callback/route.ts:79-86`):
```typescript
cookieStore.set('twica_session', sessionData, {  // 定数を使用すべき
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  path: '/',
  maxAge: 60 * 60 * 24 * 30,
})
```

**推奨事項:**
```typescript
import { COOKIE_NAMES } from '@/lib/constants'
// ...
cookieStore.set(COOKIE_NAMES.SESSION, sessionData, {
```

---

## 3. 軽微な問題（オプション修正）

### 3.1 画像アップロードのファイル名処理
**重要度: 低**

`src/app/api/upload/route.ts`でファイル拡張子の抽出に`split('.').pop()`を使用していますが、ファイル名に複数のドットが含まれている場合、意図しない動作をする可能性があります。

**問題箇所** (`src/app/api/upload/route.ts:35`):
```typescript
const ext = file.name.split('.').pop();
```

**推奨事項:** より堅牢な拡張子抽出ロジックを使用してください。

例:
```typescript
const ext = file.name.slice(((file.name.lastIndexOf('.') - 1) >>> 0) + 2);
```

### 3.2 eslint-disable-next-lineコメント
**重要度: 低**

以下のファイルで不必要な`eslint-disable-next-line`コメントが残っています:

- `src/app/api/cards/[id]/route.ts:38, 107`
- `src/app/api/twitch/eventsub/route.ts:26`

**推奨事項:** 適切な型定義を使用して、これらのコメントを削除してください。

---

## 4. セキュリティ上の検討事項

### 4.1 レート制限の欠如
**重要度: 低**

以下のAPIエンドポイントにレート制限がありません:
- `/api/upload` - 画像アップロード
- `/api/gacha` - ガチャ実行
- `/api/cards` - カード管理

**推奨事項:** Vercelのレート制限機能、またはupstash/ratelimitなどのライブラリを検討してください。

### 4.2 Middlewareでのセッション検証
**重要度: 低**

`src/middleware.ts`ではセッションの存在を検証していません。現在の実装はSupabaseセッションのみを更新しています。

**現状:**
```typescript
export async function middleware(request: NextRequest) {
  return await updateSession(request)
}
```

**推奨事項:** 重要なルートに対しては、明示的なセッション検証を追加してください。

---

## 5. コード品質評価

### 5.1 良い点

- **TypeScript型安全性**: 適切に型定義が使用されています
- **環境変数検証**: `src/lib/env-validation.ts`で必須環境変数が検証されています
- **エラーハンドリング**: `Result`型和`handleApiError`関数が適切に実装されています
- **認証フロー**: CSRF対策（state）、セッション管理が適切に実装されています
- **データベースセキュリティ**: RLSポリシーが設計されています
- **リアルタイム機能**: Supabase Realtimeを使用したオーバーレイ更新が実装されています

### 5.2 改善された点

- ガチャ確率アルゴリズムのテストが適切に実装されています
- カード所有権検証がAPIレベルで実装されています
- セッションCookieの検証が適切に実装されています

---

## 6. テスト

### 6.1 既存のテスト

`tests/unit/gacha.test.ts`で重み付き選択アルゴリズムのテストが適切に実装されています。

### 6.2 推奨される追加テスト

- APIエラーハンドリングのテスト
- 認証フローのテスト
- ファイルアップロードのテスト
- Realtime接続のテスト

---

## 7. 設計書との整合性

### 7.1 ストレージ選定

設計書では画像ストレージに「Vercel Blob」を使用すると記載されていますが、実装では`src/app/api/upload/route.ts`で`supabase.storage`を使用しています。

**推奨事項:** 設計書を更新するか、実装をVercel Blobに移行してください。

---

## 8. 総括

TwiCaプロジェクトは、前回レビューで指摘された重大な問題が大多数が修正され、コード品質が向上しています。

**修正済み:**
- GachaServiceの重複ロジック ✅
- カードAPI所有権検証 ✅
- selectWeightedCardゼロ重み処理 ✅

**残存する軽微な問題:**
- セッションCookie名の定数使用（低優先度）
- ファイル拡張子抽出ロジック（低優先度）
- eslintコメントの整理（低優先度）
- レート制限（オプション）
- Middlewareセッション検証（オプション）

**総合評価:** QAプロセスに進むのに問題はありません。軽微な問題は将来の迭代で修正可能です。

---

## チェックリスト

### 設計書との整合性
- [x] アーキテクチャパターンの実装
- [ ] ストレージ選定の一貫性（設計書更新または実装変更が必要）

### セキュリティ
- [x] Twitch OAuth認証
- [x] CSRF対策
- [x] 署名検証
- [ ] レート制限（オプション）
- [ ] セッション検証強化（オプション）

### コード品質
- [x] TypeScript型安全性
- [x] 環境変数検証
- [ ] 定数の使用（一部未使用）
- [ ] eslintコメントの整理（オプション）

### 機能
- [x] カード管理機能
- [x] ガチャ機能
- [x] オーバーレイ表示
- [x] カード所有者検証

---

## 結論

**QAプロセスへの移行を推奨します。**

前回レビューで指摘された重大な問題が修正されており、軽微な問題はQAプロセスに影響しません。実装エージェントへのフィードバックは当面不要です。QAエージェントにQA依頼を行ってください。
