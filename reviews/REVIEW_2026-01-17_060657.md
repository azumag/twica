# Code Review Report

**Date:** 2026-01-17
**Reviewer:** Code Review Agent
**Scope:** docs/ARCHITECTURE.md, docs/IMPLEMENTED.md, and implementation code

---

## Executive Summary

IMPLEMENTED.mdで報告された6件の修正のうち、5件が適切に修正されています。設計書と実装の整合性が向上し、ガチャロジックのバグ、セキュリティ強化（レート制限、RLSコメント）が実装されています。

しかし、レート制限の実装に重大な問題があり、サーバーーレス環境では機能しません。

---

## 前回レビュー問題の対応状況

### 修正済み (5件)

| # | 問題 | 状態 |
|:---|:---|:---|
| #1 | 設計と実装の不整合 (GACHA_HISTORY.user_id) | ✅ 設計書を修正 |
| #2 | ガチャ選択ロジックのバグ | ✅ `return null` に変更 |
| #3 | セッション管理の設計書記載 | ✅ 「Supabase Auth + カスタムCookie」に更新 |
| #4 | Webhookエンドポイントのレート制限 | ✅ 実装済み（ただし問題あり） |
| #5 | RLSポリシーのUPDATE/DELETE缺失 | ✅ コメント追加 |
| #7 | 設計書の更新履歴 | ✅ 更新履歴に追加 |

---

## 新発見: Critical Issues

### 1. レート制限がサーバーーレス環境で機能しない

**Severity:** Critical

**Location:** `src/app/api/twitch/eventsub/route.ts:10-30`

**問題:**
```typescript
const requestCounts = new Map<string, { count: number; resetTime: number }>();

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const record = requestCounts.get(ip);

  if (!record || now > record.resetTime) {
    requestCounts.set(ip, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });
    return true;
  }

  if (record.count >= MAX_REQUESTS_PER_WINDOW) {
    return false;
  }

  record.count++;
  return true;
}
```

**問題点:**
1. `Map` は内存に格納され、Vercelのサーバーーレス環境ではコールドスタートのたびにリセットされる
2. 複数のインスタンスがある場合、各インスタンスは独立した `Map` を持つ
3. DDoS攻撃や不正なガチャ実行に対する保護が事実Impact:**
- DDo上無効

**S攻撃の可能性
- 不正なガチャ実行
- サービス妨害

**Recommendation:**
Vercel KV/Redis、または外部レート制限サービスを使用してください：

```typescript
// 例：Upstash Redisを使用
import { Redis } from '@upstash/redis';

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

async function checkRateLimit(ip: string): Promise<boolean> {
  const key = `ratelimit:${ip}`;
  const current = await redis.get(key);
  
  if (current && Number(current) >= MAX_REQUESTS_PER_WINDOW) {
    return false;
  }
  
  await redis.incr(key);
  await redis.expire(key, 60); // 60秒
  return true;
}
```

または、Vercelのレート制限機能を使用：
```typescript
import { Ratelimit } from "@upstash/ratelimit";

const ratelimit = new Ratelimit({
  redis: kv,
  limiter: Ratelimit.slidingWindow(100, "1 m"),
});
```

---

## 新発見: Medium Severity Issues

### 2. ガチャ選択の精度問題

**Severity:** Medium

**Location:** `src/lib/gacha.ts:9-12`

**問題:**
```typescript
const scaledItems = items.map(item => ({
  ...item,
  scaledWeight: Math.round((item.drop_rate || 0) * 10000)
}))
```

**問題点:**
1. 各アイテムの重みを個別に丸めるため、合計が正確でなくなる可能性
2. 非常に小さいドロップ率（例：0.0001）の場合、丸めにより0になる可能性
3. DECIMAL(5,4)では0.0001まで表現可能だが、丸めにより失われる

**Impact:**
- 確率が意図しない分布になる可能性
- 非常にレアなカードが実際には選択されなくなる可能性

**Recommendation:**
```typescript
// 全アイテムのスケール後に丸めるアプローチ
const scaledItems = items.map(item => ({
  ...item,
  scaledWeight: (item.drop_rate || 0) * 10000
}));

const totalWeight = scaledItems.reduce((sum, item) => sum + item.scaledWeight, 0);

// 選択時にのみ丸める
const random = Math.floor(Math.random() * Math.round(totalWeight));
```

または、整数ベースのアプローチを完全に維持：
```typescript
// 重みを整数に変換（DECIMAL(5,4)の場合、10000倍で整数に）
const totalWeightInt = items.reduce((sum, item) => {
  return sum + Math.round((item.drop_rate || 0) * 10000);
}, 0);

if (totalWeightInt === 0) return null;

const random = Math.floor(Math.random() * totalWeightInt);
let cumulative = 0;

for (const item of items) {
  cumulative += Math.round((item.drop_rate || 0) * 10000);
  if (random < cumulative) {
    return item;
  }
}

return null;
```

---

### 3. セッションCookieの期限検証がない

**Severity:** Medium

**Location:** `src/lib/session.ts:13-28`

**問題:**
```typescript
export async function getSession(): Promise<Session | null> {
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(COOKIE_NAMES.SESSION)?.value

  if (!sessionCookie) {
    return null
  }

  try {
    const session = JSON.parse(sessionCookie) as Session
    return session  // 有効期限をチェックしていない
  } catch (error) {
    logger.error('[Session] Failed to parse session cookie:', error);
    return null
  }
}
```

**問題点:**
1. Cookieの `maxAge` は設定されているが、セッション自体には有効期限がない
2. 30日が経過した後も、有効なJSONとして解析できればセッションがそのまま使用される
3. 設計書では「セッション有効期限: 30日」とあるが、実装では検証されていない

**Impact:**
- セッションの固定化攻撃の可能性
- 設計書との不一致

**Recommendation:**
セッションに有効期限を追加し、検証してください：

```typescript
export interface Session {
  // ... 既存のフィールド
  expiresAt: number; // Unixタイムスタンプ
}

export async function getSession(): Promise<Session | null> {
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get(COOKIE_NAMES.SESSION)?.value

  if (!sessionCookie) {
    return null
  }

  try {
    const session = JSON.parse(sessionCookie) as Session
    
    // 有効期限チェック
    if (session.expiresAt && Date.now() > session.expiresAt) {
      await clearSession();
      return null;
    }
    
    return session
  } catch (error) {
    logger.error('[Session] Failed to parse session cookie:', error);
    return null
  }
}
```

---

## 設計書と実装の整合性チェック

### ✅ 整合性が取れている項目

| 項目 | 設計書 | 実装 | 状態 |
|:---|:---|:---|:---|
| GACHA_HISTORYテーブル | user_id FKなし | user_id FKなし | ✅ |
| セッション管理 | Supabase Auth + カスタムCookie | カスタムCookie + Supabase Auth | ✅ |
| ガチャロジック | 重み付き選択 | `selectWeightedCard` 関数 | ✅ |
| RLSポリシー | 記載あり | 実装済み + コメント追加 | ✅ |
| レート制限 | 言及なし | 実装済み（問題あり） | ⚠️ |

---

## セキュリティチェックリスト

| 項目 | 状態 | 備考 |
|:---|:---:|:---|
| HTTPS | ✅ | Vercelが対応 |
| RLS | ✅ | 実装済み |
| CSRF | ✅ | SameSite=Lax + state検証 |
| XSS | ✅ | Reactの自動エスケープ |
| 環境変数管理 | ✅ | env-validation.ts |
| セッション管理 | ⚠️ | 期限検証がない |
| 入力検証 | ✅ | アップロードの拡張子検証 |
| レート制限 | ❌ | サーバーーレスで機能しない |
| Twitch署名検証 | ✅ | 実装済み |

---

## コード品質チェック

| 項目 | 状態 | 備考 |
|:---|:---:|:---|
| TypeScript型安全性 | ✅ | 適切な型定義 |
| エラーハンドリング | ✅ | handleApiError使用 |
| ログ出力 | ✅ | logger使用 |
| ファイル構造 | ✅ | 適切なモジュール分割 |
| コードコメント | ✅ | 適切なコメント追加 |

---

## 推奨アクション

### 最優先 (Critical)

1. **Issue #1 を修正**
   - レート制限をVercel KV/Redisベースに変更
   - サーバーーレス環境でも機能する実装

### 高優先度 (Medium)

2. **Issue #2 を修正**
   - ガチャ選択の精度問題を修正
   - 小さなドロップ率でも正しく機能するように

3. **Issue #3 を修正**
   - セッションの有効期限検証を追加
   - 設計書との整合性を確保

### 中優先度

4. **ARCHITECTURE.mdの更新**
   - レート制限の記載を追加（実装に合わせて）
   - セッション有効期限の詳細を記載

---

## 評価

**Overall:** 🟡 **Needs Revision (Critical Issues Fixed)**

前回指摘された5件の問題は適切に修正されています。しかし、レート制限の実装がサーバーーレス環境で機能しないという重大な問題が発見されました。この問題が修正されれば、QAフェーズに進むことができます。

---

## 確認済みファイル

| ファイル | バージョン/行数 |
|:---|:---|
| docs/ARCHITECTURE.md | 480行 |
| docs/IMPLEMENTED.md | 203行 |
| src/lib/gacha.ts | 32行 |
| src/app/api/twitch/eventsub/route.ts | 149行 |
| supabase/migrations/00001_initial_schema.sql | 160行 |
| src/lib/session.ts | 39行 |
| src/types/database.ts | 193行 |
