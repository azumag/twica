# Code Review Report

**Date:** 2026-01-17
**Reviewer:** Code Review Agent
**Scope:** docs/ARCHITECTURE.md, docs/IMPLEMENTED.md, and implementation code

---

## Executive Summary

前レビューで指摘された6件のうち4件は適切に修正されましたが、1件の重大な問題が未解決のままです。また、新しい問題も発見されました。実装エージェントによる修正が必要です。

---

## 前回レビュー問題の対応状況

### ✅ 修正済み (4件)

| # | 問題 | 状態 |
|:---|:---|:---:|
| #2 | 浮動小数点精度問題 | ✅ 整数ベースの計算に変更済み |
| #3 | ファイルアップロードのセキュリティ | ✅ 拡張子ホワイトリスト検証を追加 |
| #4 | エラーメッセージの情報漏洩 | ✅ ログ出力を追加、一般化済み |
| #6 | ユーザーの存在確認 | ✅ upsertによる自動作成ロジックを追加 |

### ❌ 未解決 (1件)

| # | 問題 | 状態 |
|:---|:---|:---:|
| #1 | 設計と実装の不整合 (GACHA_HISTORY.user_id) | ❌ 未修正 |

---

## 未解決: Critical Issues

### 1. 設計と実装の不整合: GACHA_HISTORY.user_id

**Severity:** Critical

**Location:** `docs/ARCHITECTURE.md:231-239` vs `supabase/migrations/00001_initial_schema.sql:54-62`

**Issue:**
設計書では `GACHA_HISTORY` テーブルに `user_id UUID FK` が定義されていますが、実際のマイグレーションファイルには存在しません。

**設計書の記載:**
```sql
GACHA_HISTORY {
    UUID user_id FK          -- USERS.id を参照
    ...
}
```

**実際の実装:**
```sql
-- migration:54-62
CREATE TABLE gacha_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_twitch_id TEXT NOT NULL,  -- user_id FK がない
  user_twitch_username TEXT,
  card_id UUID NOT NULL REFERENCES cards(id),
  streamer_id UUID NOT NULL REFERENCES streamers(id),
  redeemed_at TIMESTAMPTZ DEFAULT NOW()
);
```

**types/database.ts:139-164 にも `user_id` が定義されていません。**

**Impact:**
- RLSポリシーの実装が困難
- 視聴者の履歴閲覧機能が不完全
- 設計書と実装の乖離による開発混乱

**Recommendation:**
設計書の `GACHA_HISTORY` テーブル定義を実際の実装に合わせて修正してください：

```sql
GACHA_HISTORY {
    UUID id PK
    TEXT user_twitch_id
    TEXT user_twitch_username
    UUID card_id FK
    UUID streamer_id FK
    TIMESTAMPTZ redeemed_at
}
```

または、実際に `user_id` カラムを追加する場合は：
1. マイグレーションファイルに ALTER TABLE を追加
2. types/database.ts の型定義を更新
3. INSERT クエリに user_id を追加

---

## 新発見: Critical Issues

### 2. ガチャ選択ロジックのバグ

**Severity:** Critical

**Location:** `src/lib/gacha.ts:30`

**Issue:**
ループ終了後、`items[items.length - 1]` を返すフォールバックロジックに問題があります。

```typescript
for (const item of scaledItems) {
  cumulative += item.scaledWeight
  if (random < cumulative) {
    return item
  }
}

return items[items.length - 1]  // 問題あり
```

**問題点:**
1. `totalWeight === 0` のケースは既に処理されているため、この行に到達することは理论上ありません
2. 到達した場合、最後のカードを返すのは論理的におかしい
3. デバッグが困難になる

**Impact:**
- 確率分布が崩れる可能性
- デバッグ困難

**Recommendation:**
```typescript
// 最後のカードではなく null を返す
return null

// または、より厳密には：
// cumulative が totalWeight を超えるはずがないため、assertion を追加
if (cumulative < totalWeight) {
  logger.error('Gacha selection logic error: cumulative < totalWeight')
}
return null
```

---

## 新発見: High Severity Issues

### 3. セッション管理の不整合

**Severity:** High

**Location:** `src/lib/session.ts`, `src/lib/supabase/middleware.ts`, `src/middleware.ts`

**Issue:**
独自のセッションCookieとSupabase Authの両方を使用しており、整合性に欠けます。

**実装状況:**
```typescript
// session.ts - カスタムセッション
cookieStore.set(COOKIE_NAMES.SESSION, sessionData, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  path: '/',
  maxAge: 60 * 60 * 24 * 30,
})

// middleware.ts - Supabase Auth を使用
await supabase.auth.getUser()
```

**問題点:**
1. 二重の認証システム（カスタムCookie + Supabase Auth JWT）
2. 設計書には「Supabase Authを使用したJWTベースのセッション管理」とあるが、実際にはカスタムCookieを使用
3. カスタムセッションには expire トークンが含まれていない可能性

**Impact:**
- セッション管理の複雑化
- セキュリティリスク
- 設計書との乖離

**Recommendation:**
設計書の「セッション管理」の説明を実態に合わせて修正してください。

---

### 4. Webhookエンドポイントにレート制限なし

**Severity:** High

**Location:** `src/app/api/twitch/eventsub/route.ts`

**Issue:**
EventSub webhookエンドポイントにレート制限がありません。

**Impact:**
- DDoS攻撃の可能性
- 不正なガチャ実行

**Recommendation:**
Vercelのレート制限機能またはUpstash Redisを使用したレート制限を実装してください。

```typescript
// 簡易的な例
const RATE_LIMIT_WINDOW = 60000; // 1分
const MAX_REQUESTS = 100;

// または Vercel KV を使用
import { kv } from '@vercel/kv';
```

---

## 新発見: Medium Severity Issues

### 5. RLSポリシーのUPDATE/DELETE缺失

**Severity:** Medium

**Location:** `supabase/migrations/00001_initial_schema.sql:148-156`

**Issue:**
`gacha_history` テーブルには INSERT と SELECT のポリシーがありますが、UPDATE と DELETE のポリシーがないか、コメントがありません。

**現状:**
```sql
-- Service role can insert gacha history
CREATE POLICY "Service can insert gacha history" ON gacha_history
  FOR INSERT WITH CHECK (true);

-- Users can view their own gacha history
CREATE POLICY "Users can view own gacha history" ON gacha_history
  FOR SELECT USING (
    user_twitch_id = auth.jwt() ->> 'twitch_user_id'
  );
```

**Recommendation:**
意図的に UPDATE/DELETE を禁止している場合は、コードコメントで「履歴はイミュータブル」と明記してください。

---

## 新発見: Code Quality Issues

### 6. ファイル構造の冗長性

**Location:** `src/lib/gacha.ts` と `src/lib/services/gacha.ts`

**Issue:**
二つのファイルに同様の機能があります。

- `src/lib/gacha.ts`: `selectWeightedCard` 関数のみ（ utility 関数）
- `src/lib/services/gacha.ts`: `GachaService` クラス（ビジネスロジック）

**現状分析:**
現在の構造は実際には合理的です：
- `gacha.ts` は純粋関数として確率計算を担当
- `services/gacha.ts` はサービスクラスとしてデータベース操作を担当

**Recommendation:**
現状の構造で問題ありません。統合する必要はありません。

---

## 設計書の更新が必要な項目

### 7. 設計書の更新履歴と実装の不一致

**Location:** `docs/ARCHITECTURE.md:474-478`

**Issue:**
更新履歴にIMPLEMENTED.mdで言及されている変更の一部が反映されていません。

**Recommendation:**
設計書の更新履歴を更新してください：

```markdown
| 日付 | 変更内容 |
|:---|:---|
| 2026-01-17 | 初版作成。基本アーキテクチャの定義 |
| 2026-01-17 | GACHA_HISTORYテーブルにuser_id FKを追加、drop_rateのDECIMAL精度をDECIMAL(5,4)に定義 |
| 2026-01-17 | 重み付き選択アルゴリズムを整数計算に変更 |
```

---

## セキュリティチェックリスト

| 項目 | 状態 | 備考 |
|:---|:---:|:---|
| HTTPS | ✅ | Vercelが対応 |
| RLS | ✅ | 実装済み |
| CSRF | ⚠️ | SameSite=Laxのみ、state検証あり |
| XSS | ✅ | Reactの自動エスケープ |
| 環境変数管理 | ✅ | env-validation.ts |
| セッション管理 | ⚠️ | カスタムCookie + Supabase Authの混在 |
| 入力検証 | ✅ | アップロードの拡張子検証済み |
| レート制限 | ❌ | 未実装 |

---

## 推奨アクション

1. **Issue #1, #2 を最優先で修正**
   - 設計書と実装の整合性を確保
   - ガチャロジックのバグを修正

2. **Issue #3, #4 を次に修正**
   - セッション管理の設計書記載を実態に合わせる
   - レート制限を実装

3. **Issue #5, #7 を対応**
   - RLSポリシーのコメント追加
   - 設計書の更新

4. **修正完了后再レビュー**

---

## 評価

**Overall:** 🔴 **Needs Revision**

4件の問題は適切に修正されましたが、重大な問題がまだ残っています。特に設計と実装の不整合は最優先で解決する必要があります。

