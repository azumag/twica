# コードレビュー: Issue #13 APIレート制限実装（再修正レビュー）

## 概要

実装エージェントによるレビュー修正（重複JSONパース解消）の再レビューを実施しました。JSONパースの重複は解消されていますが、複数の重大な問題が発見されました。

---

## 判定

**判定**: ❌ 重大な問題あり - 実装エージェントにフィードバックを行ってください

---

## 発見された問題

### 1. 重大な問題: 不明なメッセージタイプがレート制限をバイパス（高）

**ファイル**: `src/app/api/twitch/eventsub/route.ts:61-90`

**問題**: レート制限チェックがif-elseチェーンの内部に配置されているため、不明なメッセージタイプがレート制限を完全にバイパスします。

```typescript
// 現在のコード（問題あり）
if (messageType === MESSAGE_TYPE_NOTIFICATION) {
  // レート制限なし
  return NextResponse.json({ received: true });
}

// レート制限チェック（verification/revocationのみ）
const rateLimitResult = await checkRateLimit(rateLimits.eventsub, identifier);
// ...
if (!rateLimitResult.success) { /* 429 */ }

if (messageType === MESSAGE_TYPE_VERIFICATION) { /* ... */ }
if (messageType === MESSAGE_TYPE_REVOCATION) { /* ... */ }
return NextResponse.json({ error: "Unknown message type" }, { status: 400 });  // レート制限なし！
```

**影響**:
- 不明なメッセージタイプに対して無制限のリクエストが可能
- 悪意あるユーザーがレート制限をバイパスする可能性
- DoS攻撃のリスク

**修正案**:
```typescript
// レート制限チェックを先に実行
if (messageType !== MESSAGE_TYPE_NOTIFICATION) {
  const ip = getClientIp(request);
  const identifier = `ip:${ip}`;
  const rateLimitResult = await checkRateLimit(rateLimits.eventsub, identifier);

  if (!rateLimitResult.success) {
    return NextResponse.json(
      { error: "Too many requests" },
      { status: 429, headers: { /* ... */ } }
    );
  }
}

if (messageType === MESSAGE_TYPE_NOTIFICATION) { /* ... */ }
if (messageType === MESSAGE_TYPE_VERIFICATION) { /* ... */ }
// ...
```

---

### 2. 重大な問題: JSONパースエラー处理的缺失（高）

**ファイル**: `src/app/api/twitch/eventsub/route.ts:38`

**問題**: `JSON.parse(body)` は無効なJSONに対して例外をスローしますが、try-catchでラップされていません。

```typescript
export async function POST(request: NextRequest) {
  const body = await request.text();
  const data = JSON.parse(body);  // エラー発生可能性
  // ...
}
```

**影響**:
- 無効なJSONを含むリクエストで500エラー
- 予期しないサーバーエラー
- デバッグ困難

**修正案**:
```typescript
export async function POST(request: NextRequest) {
  const body = await request.text();
  let data;
  try {
    data = JSON.parse(body);
  } catch (e) {
    logger.error("Invalid JSON in request body", { error: e });
    return NextResponse.json({ error: "Invalid request body" }, { status: 400 });
  }
  // ...
}
```

---

### 3. 重大な問題: verifyTwitchSignatureのクラッシュリスク（中）

**ファイル**: `src/app/api/twitch/eventsub/route.ts:21-33`

**問題**: `TWITCH_EVENTSUB_SECRET`がnullの場合、`timingSafeEqual`でクラッシュする可能性があります。

```typescript
function verifyTwitchSignature(
  messageId: string,
  timestamp: string,
  body: string,
  signature: string
): boolean {
  const secret = process.env.TWITCH_EVENTSUB_SECRET;
  if (!secret) return false;  // ここでfalseを返すが...

  const message = messageId + timestamp + body;
  const expectedSignature = "sha256=" + crypto
    .createHmac("sha256", secret)
    .update(message)
    .digest("hex");

  return crypto.timingSafeEqual(
    Buffer.from(expectedSignature),
    Buffer.from(signature)  // signatureが空文字列の場合、クラッシュ
  );
}
```

**問題点**:
- `signature`が空文字列の場合、`Buffer.from("")`の長さは0
- `expectedSignature`の長さは64（sha256）
- `timingSafeEqual`は長さが異なるバッファで例外をスロー

**修正案**:
```typescript
function verifyTwitchSignature(
  messageId: string,
  timestamp: string,
  body: string,
  signature: string
): boolean {
  const secret = process.env.TWITCH_EVENTSUB_SECRET;
  if (!secret || !signature) return false;

  const message = messageId + timestamp + body;
  const expectedSignature = "sha256=" + crypto
    .createHmac("secret", message)
    .digest("hex");

  try {
    return crypto.timingSafeEqual(
      Buffer.from(expectedSignature),
      Buffer.from(signature)
    );
  } catch {
    return false;
  }
}
```

---

### 4. 軽微な問題: 未使用インポート（小）

**ファイル**: `src/app/api/twitch/eventsub/route.ts:9`

```typescript
import { checkRateLimit, rateLimits, getClientIp } from "@/lib/rate-limit";
```

**問題**:
- `checkRateLimit`と`rateLimits`は`MESSAGE_TYPE_NOTIFICATION`では使用されない
- 冗長なインポート

**修正案**:
```typescript
import { getClientIp } from "@/lib/rate-limit";
```

または

```typescript
import { checkRateLimit, rateLimits, getClientIp } from "@/lib/rate-limit";
// checkRateLimitとrateLimitsを使用しない場合は削除
```

---

## 修正優先順位

1. **高**: 不明なメッセージタイプのレート制限バイパスを修正
2. **高**: JSONパースエラー処理を追加
3. **中**: verifyTwitchSignatureのnullチェックを強化
4. **低**: 未使用インポートを削除

---

## 総括

重複したJSONパースの解消は正しく実装されていますが、レート制限のロジックに重大なバグが存在します。特に、不明なメッセージタイプがレート制限をバイパスする問題は、セキュリティ上のリスクが高く、優先的に修正する必要があります。

**判定**: ❌ 重大な問題あり - 実装エージェントにフィードバックを行ってください

実装エージェントが重大な問題を修正した後、再レビューを実施します。

---

## 参照

- 設計書: `docs/ARCHITECTURE.md`
- 実装記録: `docs/IMPLEMENTED.md`
- コード: `src/lib/rate-limit.ts`, `src/app/api/twitch/eventsub/route.ts`
