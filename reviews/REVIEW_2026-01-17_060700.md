# コードレビュー結果

**レビュー日:** 2026-01-17
**レビュー対象:** docs/ARCHITECTURE.md, docs/IMPLEMENTED.md, および実装コード

---

## 重大な問題 (Critical Issues)

### #1 RLSポリシーが機能しない（セキュリティ上の重大な欠陥）

**対象ファイル:** `supabase/migrations/00001_initial_schema.sql:112-113`, `supabase/migrations/00001_initial_schema.sql:123-124`, `supabase/migrations/00001_initial_schema.sql:129-130`, `supabase/migrations/00001_initial_schema.sql:136-137`, `supabase/migrations/00001_initial_schema.sql:144-145`, `supabase/migrations/00001_initial_schema.sql:158-159`

**問題:**
RLSポリシーで `auth.jwt() ->> 'twitch_user_id'` を参照していますが、実装ではSupabase AuthのJWTトークンを使用していません。代わりに、カスタムCookieにセッション情報を保存する方式を採用しています。

**現在の実装:**
- `src/app/api/auth/twitch/callback/route.ts` でカスタムセッションCookieを設定
- Supabase AuthのJWTトークンを発行・使用していない

**影響:**
- RLSポリシーが常に false を返す可能性
- 配信者が自分のカードを管理できない
- 視聴者が自分のカード/履歴を見れない
- データベースレベルのセキュリティが完全に失效

**修正案:**
1. **オプションA: Supabase Authに移行**
   - Supabase Authのセッション管理を使用
   - RLSポリシーが期待通り動作

2. **オプションB: アプリケーション層で認証を実装**
   - RLSポリシーを削除または簡素化
   - すべてのAPIでセッションCookieを検証
   - アプリケーションコードでアクセス制御

---

### #2 セッションCookieとSupabase Authの二重システム

**対象ファイル:** `src/lib/session.ts`, `src/app/api/auth/twitch/callback/route.ts`

**問題:**
設計書では「Supabase Auth + カスタムCookie」と記載されていますが、実装はカスタムCookieのみを使用しています。Supabase Authの実際の機能は使用されていません。

**現在の実装:**
```typescript
// session.ts でセッションを直接管理
const sessionData = JSON.stringify({
  twitchUserId: twitchUser.id,
  expiresAt: Date.now() + SESSION_DURATION,
})
cookieStore.set(COOKIE_NAMES.SESSION, sessionData, {...})
```

**影響:**
- 設計と実装の不一致
- 将来的なSupabase Auth機能の追加が困難
- RLSとの連携が不可能

**修正案:**
- 設計書を「カスタムCookie方式」に更新するか
- 実装をSupabase Auth方式に変更

---

## 中程度の問題 (Medium Issues)

### #3 ドロップ率0のカードの挙動

**対象ファイル:** `src/lib/gacha.ts:20-24`

**問題:**
ドロップ率が0のカードが選択される可能性があります（`random < cumulative` の境界条件）。

```typescript
for (const item of items) {
  cumulative += Math.round((item.drop_rate || 0) * 10000)
  if (random < cumulative) {  // 0のカードも選択される可能性
    return item
  }
}
```

**現在のテスト:**
```typescript
// tests/unit/gacha.test.ts:42-52
it('handles zero drop rate items', () => {
  const cards: WeightedCard[] = [
    { id: 'never', drop_rate: 0 },
    { id: 'always', drop_rate: 1.0 }
  ]
  const result = selectWeightedCard(cards)
  // Zero drop rate items may be selected
  expect(['never', 'always']).toContain(result?.id)
})
```

**影響:**
- 設計上「ドロップ率0のカードは排出されない」が、実装では排出される可能性がある
- 配信者の設定意図と実際の挙動が不一致

**修正案:**
```typescript
const itemWeight = Math.round((item.drop_rate || 0) * 10000)
if (itemWeight > 0 && random < cumulative) {
  return item
}
```

---

### #4 環境変数の런타임検証不足

**対象ファイル:** `src/lib/env-validation.ts:44-47`

**問題:**
環境変数の検証がモジュールインポート時に行われるため、Vercelの環境変数設定が間に合わない場合があります。

```typescript
const { valid, missing } = validateEnvVars()
if (!valid && process.env.NODE_ENV !== 'test') {
  throw new Error(`Missing required environment variables: ${missing.join(', ')}`)
}
```

**影響:**
- Vercelデプロイ時にエラーが発生する可能性
- 環境変数が設定される前にエラーとなる

**修正案:**
- 必要なAPIルートで lazily 検証
- またはVercelのBuild-time設定を活用

---

## 軽微な問題 (Minor Issues)

### #5 エラーハンドリングの改善余地

**対象ファイル:** `src/app/api/auth/twitch/callback/route.ts:95-100`

**問題:**
認証エラー時に詳細なエラー情報が漏洩する可能性があります。

```typescript
const errorMessage = err instanceof Error ? err.message : 'auth_failed'
return NextResponse.redirect(
  `${process.env.NEXT_PUBLIC_APP_URL}/?error=${encodeURIComponent(errorMessage)}`
)
```

**影響:**
- 内部実装情報がユーザーに表示される可能性

**修正案:**
```typescript
return NextResponse.redirect(
  `${process.env.NEXT_PUBLIC_APP_URL}/?error=auth_failed`
)
```

---

### #6 デザイン原則との不整合

**問題:**
設計書の「Simple over Complex」の原則と反する部分があります。

1. `Result<T>`型の使用 (`src/types/result.ts`)
   - 複雑さの増加
   - 標準的なError handlingからの逸脱

2. `GachaService`クラスの過剰な抽象化
   - 単純な関수로十分対応可能

**影響:**
- コードの可読性低下
- 保守性の低下

---

### #7 データベースのCHECK制約

**対象ファイル:** `supabase/migrations/00001_initial_schema.sql:28`

**問題:**
`drop_rate` 列に `CHECK (drop_rate >= 0 AND drop_rate <= 1)` がありますが、複数カードのドロップ率合計が1.0を超える場合の検証がありません。

**影響:**
- ドロップ率合計が1.0を超える設定が可能
- ガチャの確率が意図しない動作をする可能性

**修正案:**
データベーストリガーまたはアプリケーション層で検証

---

## 確認済み適切な実装

### ✓ セキュリティ対策
- Twitch署名検証が適切に実装 (`src/app/api/twitch/eventsub/route.ts:16-35`)
- Cookie設定がセキュリティを意識 (`sameSite: 'lax'`, `httpOnly: true`)
- CSRF対策（state検証）が実装

### ✓ セッション管理
- expiresAt による期限検証が実装
- セッション期限（30日）が適切

### ✓ ガチャアルゴリズム
- 整数計算による精度問題が修正
- テストカバレッジが十分

### ✓ レート制限
- Vercel Serverless環境で機能しないため削除（適切な判断）

---

## 推奨アクション

1. **即座に修正が必要:**
   - #1 RLSポリシーの問題を修正（最優先）
   - #2 設計と実装の整合性を確保

2. **次の sprint で修正:**
   - #3 ドロップ率0のカード挙動を明確に
   - #5 エラーハンドリングの改善
   - #7 ドロップ率合計の検証

3. **検討:**
   - #6 過度な抽象化の解消

---

## 影響を受ける受け入れ基準

| 基準 | 影響 |
|:---|:---|
| データ整合性 > RLSポリシーが正しく機能する | ❌ 機能しない |
| データ整合性 > 配信者は自分のカードしか編集できない | ❌ 機能しない可能性 |
| データ整合性 > 視聴者は自分のカードしか見れない | ❌ 機能しない可能性 |

---

## レビュー結果

**ステータス:** ❌ 問題あり（実装エージェントにフィードバックが必要）

**理由:** RLSポリシーが機能しない重大なセキュリティ問題が発見されました。
