# コードレビュー

## レビュー日

2026-01-17

## レビュー対象

Issue #11: カードアップロード容量制限の実装（レビュー修正版）

## レビュー結果: 承認

修正された実装をレビューした結果、すべての問題が解決されました。

---

## レビュー詳細

### 1. セキュリティ上の問題: MIMEタイプ + 拡張子検証 ✅ 解決済み

**場所**: `src/lib/upload-validation.ts:6-20`

**修正内容確認**:
- ✅ `TYPE_TO_EXTENSIONS`マッピングが追加され、JPEG/PNGのみを許可
- ✅ `getFileExtension()`関数が追加され、ファイル名から拡張子を取得
- ✅ `validateFileType()`関数が追加され、MIMEタイプと拡張子の整合性を検証

**評価**: セキュリティ要件が適切に満たされています。MIME type spoofingへの対策が実装されています。

---

### 2. UXの不整合: エラー表示の統一 ✅ 解決済み

**場所**: `src/components/CardManager.tsx:85`

**修正内容確認**:
- ✅ `alert()`から`setUploadError()`に変更
- ファイル選択時とフォーム送信時のエラー表示が統一された

**評価**: UXの一貫性が確保されています。

---

### 3. file.nameのnull/undefinedチェック ✅ 解決済み

**場所**: `src/app/api/upload/route.ts:26-28`

**修正内容確認**:
- ✅ `file.name`のnull/空文字チェックが追加
- ✅ 型アサーション`(file as File)`が削除され、nullチェック後に`file`を直接使用

**評価**: 適切なnullチェックが実装されています。

---

## 追加レビュー: コード品質評価

### ✅ コード簡潔性

- 過度な抽象化がない
- 関数分離が適切（`getFileExtension`, `validateFileType`）
- コードが簡潔で読みやすい

### ✅ 型安全性

- TypeScriptの型が適切に使用されている
- `as const`で不変性を確保
- エラータイプの共用体が適切

### ✅ エラーハンドリング

- クライアントサイドとサーバーサイド両方で検証
- 適切なエラーメッセージ（日本語）
- 検証失敗時のHTTPステータスコードが適切（400）

### ✅ セキュリティ

- MIMEタイプと拡張子の両方を検証
- ファイルサイズ制限（1MB）
- 許可された形式のみ（JPEG, PNG）

---

## 受け入れ基準の確認

| 基準 | 状態 |
|:---|:---|
| 1MB以上の画像がアップロードできない | ✅ 検証済み |
| JPEG/PNG以外の画像がアップロードできない | ✅ 検証済み |
| 適切なエラーメッセージが表示される | ✅ 検証済み |
| クライアントサイドとサーバーサイド両方で検証される | ✅ 検証済み |

---

## 軽微な改善提案（オプション）

以下の点は改善の余地がありますが、必須ではありません：

1. **`upload-validation.ts:76`**: switch case内の変数宣言をブロックで囲むことを検討

```typescript
case 'FILE_TOO_LARGE': {
  const sizeInMB = maxSize ? (maxSize / (1024 * 1024)).toFixed(1) : '1';
  return `ファイルサイズは${sizeInMB}MB以下にしてください`;
}
```

2. **型の安全性向上**: 非-nullアサーション演算子（`!`）の使用を避け、 明示的なnullチェックを検討

---

## 結論

**承認**

修正された実装は設計書に従って適切に実装されており、すべてのレビュー項目が解決されています。

**QAへの移行を推奨します。**

---

## チェックリスト

### コード品質
- [x] TypeScriptの型が適切に使用されている
- [x] 過度な抽象化がない
- [x] コードが簡潔である

### セキュリティ
- [x] ファイルアップロードの検証が十分である
- [x] MIME type spoofingへの対策がある
- [x] 拡張子と内容の整合性検証がある

### パフォーマンス
- [x] 不要な検証処理がない
- [x] クライアントサイド検証が適切なタイミングで行われている

### UX
- [x] エラーメッセージが明確である
- [x] エラー表示が一貫している
