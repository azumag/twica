# 実装内容 - 2026-01-17

## Issue #23: Fix CPU Opponent Database Inconsistency in Battle System

### 概要
CPU対戦相手のデータベース参照に不整合がある問題を修正しました。

### 問題点
- `battles.opponent_card_id` は `cards(id)` への外部キー参照を持っている
- CPU対戦相手はランダムに生成される仮想的なカードで、実際にはデータベースに存在しない
- 現在は `allCards[0]?.id` をプレースホルダーとして使用しており、データベースの整合性を破壊している

### 実装内容

#### 1. データベースマイグレーション
**ファイル**: `supabase/migrations/00003_fix_cpu_opponent_inconsistency.sql`
- `opponent_card_id` を NULL許容に変更
- `opponent_card_data` (JSONB) カラムを追加
- カラムにコメントを追加して用途を明確化

#### 2. 型定義の更新
**ファイル**: `src/types/database.ts`
- `Database['public']['Tables']['battles']` インターフェースを更新
  - `opponent_card_id` を `string | null` に変更
  - `opponent_card_data` を `Json | null` として追加
- `OpponentCardData` インターフェースを新規追加
  - CPU対戦相手のカードデータ構造を定義
  - id, name, hp, atk, def, spd, skill_type, skill_name, image_url, rarity を含む

#### 3. APIの修正
**ファイル**: `src/app/api/battle/start/route.ts`
- CPU対戦相手のデータを `opponent_card_data` に格納する処理を追加
- CPU対戦の場合は `opponent_card_id` に `null` を設定
- プレイヤー対プレイヤー（将来の実装）に対応できる構造に変更

### 変更点の詳細
- データベースの整合性を確保
- 将来の拡張性（PvP実装）に対応
- CPU対戦相手の正確なデータ記録を実現

---

## Issue #24: Remove Hardcoded Gacha Cost Value

### 概要
ガチャコストのハードコード値を削除し、環境変数から取得するように変更しました。

### 問題点
- `src/app/api/gacha/route.ts:74` でガチャコストが `cost: 100` とハードコードされている
- コストを変更する場合、コードの変更が必要
- 環境ごとに異なるコストを設定できない
- エラーレポートでコストが常に100として記録される

### 実装内容

#### 1. 定数の追加
**ファイル**: `src/lib/constants.ts`
- `GACHA_COST` 定数を追加
- 環境変数 `GACHA_COST` から値を取得（デフォルト値: 100）

#### 2. 環境変数検証の追加
**ファイル**: `src/lib/env-validation.ts`
- `GACHA_COST` 環境変数の検証を追加
- 数値チェック、範囲チェック（1-10000）を実装

#### 3. APIの修正
**ファイル**: `src/app/api/gacha/route.ts`
- `GACHA_COST` 定数をインポート
- ハードコードされた `cost: 100` を `GACHA_COST` に変更

#### 4. ドキュメントの確認
**ファイル**: `README.md` および `.env.local.example`
- `GACHA_COST` が既にドキュメント化されていることを確認
- デフォルト値が100であることを確認

### 変更点の詳細
- 保守性の向上：コスト変更時は環境変数の変更のみで済む
- 柔軟性の向上：環境ごとに異なるコストを設定可能
- エラーレポートの正確性：正しいコスト値が記録される

---

## 検証結果

### ビルド確認
- ✅ TypeScriptコンパイルエラーなし
- ✅ Next.jsビルド成功

### コード品質
- ✅ ESLintエラーなし
- ✅ 既存のテストがすべてパス

### アーキテクチャ適合性
- ✅ 設計方針「Simple over Complex」を遵守
- ✅ 設計方針「Type Safety」を維持
- ✅ 設計方針「Security First」を維持

### 互換性
- ✅ 既存の対戦履歴との互換性を維持
- ✅ 既存のガチャ機能に回帰なし
- ✅ マイグレーションが安全に実行可能

---

## 今後の課題

1. **Issue #23**: マイグレーションの実行と既存データの移行
2. **Issue #23**: 対戦履歴表示機能での `opponent_card_data` の活用
3. **Issue #24**: 各環境で適切な `GACHA_COST` 値の設定

---

## 実装時間
- 開始時間: 2026-01-17
- 終了時間: 2026-01-17
- 総所要時間: 約30分

## レビュー依頼
レビューエージェントによるコードレビューを依頼します。