# 実装記録

## 日付

2026-01-17

## レビュー修正

### 対応したレビュー

docs/QA.md の修正依頼に対応

### 修正内容

#### 1. レート制限が未実装のAPIルートへのレート制限追加

**問題**: 一部のAPIルートにレート制限が実装されていない

**修正**:

**src/lib/rate-limit.ts** - 新しいレート制限設定を追加

```typescript
twitchRewardsGet: createRatelimit(50, 60 * 1000),
twitchRewardsPost: createRatelimit(20, 60 * 1000),
eventsubSubscribePost: createRatelimit(10, 60 * 1000),
eventsubSubscribeGet: createRatelimit(50, 60 * 1000),
gachaHistoryDelete: createRatelimit(30, 60 * 1000),
debugSession: createRatelimit(10, 60 * 1000),
```

**src/app/api/twitch/rewards/route.ts**
- GET メソッドに twitchRewardsGet (50/min) を追加
- POST メソッドに twitchRewardsPost (20/min) を追加

**src/app/api/twitch/eventsub/subscribe/route.ts**
- POST メソッドに eventsubSubscribePost (10/min) を追加
- GET メソッドに eventsubSubscribeGet (50/min) を追加

**src/app/api/gacha-history/[id]/route.ts**
- DELETE メソッドに gachaHistoryDelete (30/min) を追加

**src/app/api/debug-session/route.ts**
- GET メソッドに debugSession (10/min) を追加

#### 2. フロントエンドでの429エラーハンドリング

**問題**: CardManager.tsx で429エラーを適切にハンドリングしていない

**修正**:

**src/components/CardManager.tsx**

1. アップロードAPI (handleSubmit 内のuploadResponseチェック)
```typescript
if (uploadResponse.status === 429) {
  const errorData = await uploadResponse.json();
  setUploadError(errorData.error || "リクエストが多すぎます。しばらく待ってから再試行してください。");
  setSaving(false);
  return;
}
```

2. カードAPI (handleSubmit 内のresponseチェック)
```typescript
} else if (response.status === 429) {
  const errorData = await response.json();
  setUploadError(errorData.error || "リクエストが多すぎます。しばらく待ってから再試行してください。");
}
```

3. 削除API (handleDelete 内のresponseチェック)
```typescript
if (response.status === 429) {
  const errorData = await response.json().catch(() => ({ error: "Unknown error" }));
  const errorMessage = errorData.error || "リクエストが多すぎます。しばらく待ってから再試行してください。";
  alert(`操作失敗: ${errorMessage}`);
  logger.error("Rate limit exceeded:", errorData);
}
```

## 変更されたファイル

- `src/lib/rate-limit.ts`
- `src/app/api/twitch/rewards/route.ts`
- `src/app/api/twitch/eventsub/subscribe/route.ts`
- `src/app/api/gacha-history/[id]/route.ts`
- `src/app/api/debug-session/route.ts`
- `src/components/CardManager.tsx`

## 備考

- 設計書 docs/ARCHITECTURE.md Issue #13 のレート制限設計に基づく実装
- QAレポート docs/QA.md の必須修正項目に対応
