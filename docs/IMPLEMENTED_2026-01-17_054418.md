# 実装記録

## 日付

2026-01-17

## レビュー対応修正

### 1. ストレージ選定の修正（Vercel Blobへ変更）

**対象ファイル:**
- `src/app/api/upload/route.ts`

**変更内容:**
- Supabase StorageからVercel Blobへストレージを変更
- 設計書（docs/ARCHITECTURE.md）に記載されたストレージ選定と実装を一致させた
- `@vercel/blob`パッケージをインストール

**変更前:**
```typescript
import { getSupabaseAdmin } from '@/lib/supabase/admin';
// ...
const supabase = getSupabaseAdmin();
const { data, error } = await supabase.storage
  .from('card-images')
  .upload(fileName, file, {
    contentType: file.type,
    upsert: false,
  });
// ...
const { data: { publicUrl } } = supabase.storage
  .from('card-images')
  .getPublicUrl(data.path);
```

**変更後:**
```typescript
import { put } from '@vercel/blob';
// ...
const blob = await put(fileName, file, {
  access: 'public',
});
return NextResponse.json({ url: blob.url });
```

---

### 2. カード重複収集の問題を修正

**対象ファイル:**
- `src/lib/services/gacha.ts`

**変更内容:**
- `user_cards`テーブルへの挿入を`upsert`に変更
- `onConflict: 'user_id, card_id'`で重複を防止
- `ignoreDuplicates: true`で重複時は何もしない

**変更前:**
```typescript
const { error: collectionError } = await this.supabase
  .from('user_cards')
  .insert({
    user_id: user.id,
    card_id: selectedCard.id,
  })
```

**変更後:**
```typescript
const { error: collectionError } = await this.supabase
  .from('user_cards')
  .upsert({
    user_id: user.id,
    card_id: selectedCard.id,
    obtained_at: new Date().toISOString(),
  }, {
    onConflict: 'user_id, card_id',
    ignoreDuplicates: true,
  })
```

---

### 3. ファイル拡張子抽出の問題を修正

**対象ファイル:**
- `src/app/api/upload/route.ts`

**変更内容:**
- `split('.').pop()`から`lastIndexOf`を使用する方法に変更
- ファイル名`my.file.name.jpg`のようなケースでも正しく拡張子を取得できるようにした

**変更前:**
```typescript
const ext = file.name.split('.').pop();
```

**変更後:**
```typescript
function getFileExtension(fileName: string): string {
  const lastDotIndex = fileName.lastIndexOf('.');
  return lastDotIndex > -1 ? fileName.slice(lastDotIndex + 1) : '';
}
// ...
const ext = getFileExtension(file.name);
```

---

## テスト結果

| テストカテゴリ | 結果 |
|:---|:---:|
| ユニットテスト | 28件全てパス |
| Lint | パス |
| ビルド | 成功 |

## 変更ファイル一覧

| ファイル | 変更内容 |
|:---|:---|
| `src/app/api/upload/route.ts` | Supabase StorageからVercel Blobへ変更、拡張子抽出ロジック修正 |
| `src/lib/services/gacha.ts` | insertからupsertに変更（重複防止） |
| `package.json` | `@vercel/blob`パッケージ追加 |

## 備考

- 設計書と実装のストレージ選定が一致しました
- カードコレクションの一意性が保証されるようになりました
- ファイル拡張子の取得が正確になりました
