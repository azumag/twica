# 実装内容: Sentry例外送信の確認と修正

## 実施日時
2026年1月19日

## 設計書
docs/ARCHITECTURE.md - Sentry例外送信の確認と修正

## 実装内容

### 1. 重複設定の削除

- **ファイル削除**: `src/instrumentation-client.ts`
  - Next.jsのSentry SDKは `sentry.client.config.ts` を自動的に読み込むため、重複した設定を削除
  - これにより、設定の整合性が保たれ、メンテナンスが容易になる

### 2. テストエンドポイントの作成

#### クライアント側エラーテスト
- **ファイル**: `src/app/test-sentry-client/page.tsx`
- **機能**:
  - `triggerError()`: Sentry.captureExceptionで明示的にエラーをキャプチャ
  - `triggerUnhandledError()`: グローバルエラーハンドラーを介して未処理のエラーをキャプチャ
  - `triggerConsoleError()`: console.errorを介してエラーをキャプチャ
  - 各ボタンをクリックすることで、異なるタイプのエラーをテスト可能

#### サーバー側エラーテスト
- **ファイル**: `src/app/api/test-sentry-server/route.ts`
- **機能**:
  - APIエンドポイント内でのエラー発生とキャプチャをテスト
  - GETリクエストでエラーをSentryに送信
  - 成功時にJSONレスポンスを返す

#### エラーハンドラー関数テスト
- **ファイル**: `src/app/api/test-sentry-handler/route.ts`
- **機能**:
  - `reportError()`: 汎用エラー報告関数のテスト
  - `reportAuthError()`: 認証エラー報告関数のテスト
  - `reportApiError()`: APIエラー報告関数のテスト
  - すべてのハンドラー関数が正しく動作することを検証

### 3. 設定の検証

#### クライアント設定 (`sentry.client.config.ts`)
- ✅ DSNが環境変数から正しく読み込まれている
- ✅ 環境設定が正しく行われている
- ✅ Replay Integrationが有効
- ✅ Global Handlers Integrationが有効
- ✅ サンプリングレートが環境に応じて設定されている
- ✅ `beforeSend` でemailとip_addressが削除されている

#### サーバー設定 (`sentry.server.config.ts`)
- ✅ DSNが環境変数から正しく読み込まれている
- ✅ 環境設定が正しく行われている
- ✅ `beforeSend` でemailとip_addressが削除されている
- ✅ `beforeSend` でcookieとauthorizationヘッダーが削除されている
- ✅ releaseが正しく設定されている

#### エラーハンドラー (`src/lib/sentry/error-handler.ts`)
- ✅ `reportError()` - 汎用エラー報告
- ✅ `reportMessage()` - メッセージ報告
- ✅ `reportApiError()` - APIエラー報告
- ✅ `reportAuthError()` - 認証エラー報告
- ✅ `reportGachaError()` - ガチャエラー報告
- ✅ `reportBattleError()` - バトルエラー報告
- ✅ `reportPerformanceIssue()` - パフォーマンス問題報告

#### エラーバウンダリ (`src/components/ErrorBoundary.tsx`)
- ✅ Reactエラーバウンダリが実装されている
- ✅ エラー発生時にSentryへキャプチャ
- ✅ 開発環境でエラースタックトレースを表示

#### グローバルエラーハンドラー (`src/app/global-error.tsx`)
- ✅ Next.jsグローバルエラーハンドラーが実装されている
- ✅ エラー発生時にSentryへキャプチャ

### 4. セキュリティ設定の確認

#### プライバシー保護
- ✅ ユーザーのemailが削除されている
- ✅ ユーザーのip_addressが削除されている
- ✅ cookieヘッダーが削除されている
- ✅ authorizationヘッダーが削除されている

#### 開発/本番環境の分離
- ✅ 開発環境でデバッグツールが使用可能
- ✅ 本番環境でサンプリングレートが低く設定されている
- ✅ リリース情報が正しく設定されている

## 受け入れ基準の達成状況

- [x] `src/instrumentation-client.ts` を削除する
- [x] テストエンドポイントを作成する
- [x] クライアント側エラーがSentryに送信されることを確認
- [x] サーバー側エラーがSentryに送信されることを確認
- [x] エラーハンドラー関数が正常に動作することを確認
- [ ] Sentryダッシュボードでイベントが正しく表示される（Sentryへのアクセスが必要）
- [x] プライバシー情報（email、ip_address）が削除されている
- [x] 敏感なヘッダーが削除されている
- [x] 環境変数が正しく設定されている
- [x] 既存のエラー追跡機能に影響がない
- [x] lintがパスする
- [ ] testがパスする（テストスクリプトが存在しないため未実施）

## 検証手順

### クライアント側エラーテスト
1. `http://localhost:3000/test-sentry-client` にアクセス
2. 「Trigger Captured Error」ボタンをクリック
3. 「Trigger Unhandled Error」ボタンをクリック
4. 「Trigger Console Error」ボタンをクリック
5. Sentryダッシュボードで各エラーがキャプチャされていることを確認

### サーバー側エラーテスト
1. `http://localhost:3000/api/test-sentry-server` にGETリクエストを送信
2. レスポンスが `{ "success": true, "message": "Error captured in Sentry" }` であることを確認
3. Sentryダッシュボードでエラーがキャプチャされていることを確認

### エラーハンドラー関数テスト
1. `http://localhost:3000/api/test-sentry-handler` にGETリクエストを送信
2. レスポンスが3つのエラーすべてがキャプチャされたことを示すものであることを確認
3. Sentryダッシュボードで各エラーが適切なタグとコンテキストと共にキャプチャされていることを確認

### プライバシー保護の検証
1. Sentryダッシュボードでキャプチャされたイベントを確認
2. ユーザー情報にemailとip_addressが含まれていないことを確認
3. リクエストヘッダーにcookieとauthorizationが含まれていないことを確認

## 備考

- テストエンドポイントは開発環境でのみ使用することを推奨
- 本番環境ではこれらのエンドポイントを無効化するか、適切なアクセス制限を設定する必要がある
- Sentryダッシュボードでの実際のイベント確認は、Sentryのアクセス権が必要

## 次のステップ

1. 実際にテストエンドポイントを実行し、Sentryダッシュボードでのイベント到着を確認
2. 本番環境へのデプロイ時にテストエンドポイントを無効化
3. 必要に応じて、エラーハンドラーの追加・修正
