# 実装内容

## 実装日時
2026-01-19 01:25

## 実装概要
Issue #44: ファイルアップロードのセキュリティ強化

## 実装内容

### 1. `src/lib/file-utils.ts` の新規作成

マジックバイトによるファイルタイプ検証機能を追加しました。

- `getFileTypeFromBuffer(buffer: Buffer): string` - バッファのマジックバイトを解析してファイルタイプを識別
  - JPEG, PNG, GIF, WebP をサポート
  - 不明なファイルタイプは `application/octet-stream` を返す
- `isValidExtension(ext: string): boolean` - 拡張子の検証
- `getFileExtension(fileName: string): string` - ファイル名から拡張子を取得

### 2. `src/lib/constants.ts` の更新

ファイルアップロード関連の定数とエラーメッセージを追加しました。

- `UPLOAD_CONFIG` 定数を追加
  - `MAX_FILE_SIZE`: 1MB
  - `ALLOWED_TYPES`: `['image/jpeg', 'image/png', 'image/gif', 'image/webp']`
  - `ALLOWED_EXTENSIONS`: `['jpg', 'jpeg', 'png', 'gif', 'webp']`
  - `EXT_TO_MIME_TYPE`: 拡張子とMIMEタイプのマッピング
- `ERROR_MESSAGES.FILE_CONTENT_MISMATCH` エラーメッセージを追加
- `ERROR_MESSAGES.INVALID_FILE_TYPE` のメッセージを更新（GIFとWebPを追加）

### 3. `src/lib/upload-validation.ts` の更新

- `ALLOWED_TYPES` に `image/gif` と `image/webp` を追加
- `ALLOWED_EXTENSIONS` 配列を追加
- `EXT_TO_MIME_TYPE` マッピングを追加
- `validateFileType` 関数のロジックを更新

### 4. `src/app/api/upload/route.ts` の更新

マジックバイトによるファイルタイプ検証とファイル名のハッシュ化を実装しました。

- 拡張子の検証を強化（`UPLOAD_CONFIG.ALLOWED_EXTENSIONS` を使用）
- マジックバイトによるファイルタイプ検証を追加
  - 拡張子と実際のファイル内容が一致しない場合、400エラーを返す
- ファイル名のハッシュ化（SHA-256の一部を使用）
  - パストラバーサル攻撃を防止
  - ファイル名が推測不可能
- `logger.warn()` を使用して不一致のログを出力

### 5. `tests/unit/upload.test.ts` の更新

マジックバイト検証のテストを追加しました。

- JPEG, PNG, GIF, WebP の正常アップロードテストを追加
- ファイル内容が拡張子と一致しない場合のテストを追加
- `getFileTypeFromBuffer` のユニットテストを追加
  - JPEG, PNG, GIF, WebP の正しい識別
  - 不明なファイルタイプの識別
  - 短いバッファの処理

## セキュリティ強化の詳細

### 1. パストラバーサル攻撃の防止
- ファイル名をSHA-256ハッシュの一部（16文字）で置換
- ユーザー入力のファイル名を直接使用しない

### 2. マジックバイトによるファイルタイプ検証
- ファイルの先頭バイトを解析して実際のファイルタイプを特定
- 拡張子偽装攻撃を防止
- サポートするファイルタイプ: JPEG, PNG, GIF, WebP

### 3. 拡張子の厳格な検証
- 許可された拡張子のみを許可
- 小文字の拡張子のみを許可

## トレードオフ

### 採用したアプローチ: マジックバイトによる検証
- **メリット**:
  - 実際のファイル内容を検証できる
  - 拡張子偽装攻撃を防止できる
  - OWASP のベストプラクティスに準拠
- **デメリット**:
  - 実装の複雑度が増す
  - パフォーマンスへの影響（バッファの読み込み）
- **判断**: セキュリティ上の重要性が高いため採用

## テスト結果

- lint: パス
- test: 全76テストがパス

## 対応する設計書
- docs/ARCHITECTURE.md (Issue #44: ファイルアップロードのセキュリティ強化)
