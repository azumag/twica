# 実装記録

## 実装日

2026-01-17

## 実装内容

### Issue #11: カードアップロード容量制限の実装

設計書（docs/ARCHITECTURE.md Issue #11）に基づき、画像アップロードのサイズ・形式検証を実装しました。

### 変更ファイル

- `src/lib/upload-validation.ts`（新規作成）
- `src/app/api/upload/route.ts`
- `src/components/CardManager.tsx`

### 変更内容

#### 1. `src/lib/upload-validation.ts`（新規作成）

アップロード設定と検証関数を定義：

```typescript
export const UPLOAD_CONFIG = {
  MAX_FILE_SIZE: 1 * 1024 * 1024,  // 1MB
  ALLOWED_TYPES: ['image/jpeg', 'image/png'] as const,
}

export function validateUpload(file: File | null | undefined): ValidationResult
export function getUploadErrorMessage(error: UploadValidationError, maxSize?: number): string
```

#### 2. `src/app/api/upload/route.ts`

サーバーサイドの検証を共有モジュールに移行：

- 2MB → 1MBに変更
- JPEG, PNG, GIF, WebP → JPEG, PNGのみに制限
- 拡張子検証を簡素化

#### 3. `src/components/CardManager.tsx`

クライアントサイド検証を追加：

- ファイル選択時に即座に検証
- エラーメッセージをリアルタイム表示
- 対応形式と最大サイズを表示

### 設計書からの変更点

なし。設計書通り1MB、JPEG/PNGのみ対応。

### 受け入れ基準

- [x] 1MB以上の画像がアップロードできない
- [x] JPEG/PNG以外の画像がアップロードできない
- [x] 適切なエラーメッセージが表示される
- [x] クライアントサイドとサーバーサイド両方で検証される

---

## 実装日

2026-01-17

## 実装内容

### Issue #12: CI環境変数の問題と解決策

レビューエージェントからの依頼（docs/QA.md）に基づき、CIワークフローの環境変数不足を修正しました。

### 変更ファイル

- `.github/workflows/ci.yml`

### 変更内容

Build stepに不足している環境変数のダミー値を追加：

```yaml
env:
  NEXT_PUBLIC_SUPABASE_URL: ''
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ''
  NEXT_PUBLIC_TWITCH_CLIENT_ID: ''
  NEXT_PUBLIC_APP_URL: http://localhost:3000
  TWITCH_CLIENT_ID: dummy_client_id
  TWITCH_CLIENT_SECRET: dummy_client_secret
  TWITCH_EVENTSUB_SECRET: dummy_eventsub_secret
  SUPABASE_SERVICE_ROLE_KEY: dummy_service_role_key
  BLOB_READ_WRITE_TOKEN: dummy_blob_token
```

### 追加した環境変数

| 変数名 | 値 |
|:---|:---|
| TWITCH_CLIENT_ID | dummy_client_id |
| TWITCH_CLIENT_SECRET | dummy_client_secret |
| TWITCH_EVENTSUB_SECRET | dummy_eventsub_secret |
| SUPABASE_SERVICE_ROLE_KEY | dummy_service_role_key |
| BLOB_READ_WRITE_TOKEN | dummy_blob_token |

### 変更理由

- CIビルドでは実際のAPI接続が不要（静的解析、型チェックのみ）
- 設計書（docs/ARCHITECTURE.md Issue #12）に記載された解決策を実装
