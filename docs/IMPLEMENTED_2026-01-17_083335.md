# 実装内容 - Issue #15 カード対戦機能

## 実施日
2026-01-17

## 概要
Issue #15で要望のあったカード対戦機能を実装しました。視聴者が集めたカードを使ってCPU対戦を楽しむことができる機能です。

## 実装内容

### 1. データベース構造の拡張

#### カードテーブルの拡張
- 追加カラム:
  - `hp` (INTEGER): カードの体力
  - `atk` (INTEGER): カードの攻撃力
  - `def` (INTEGER): カードの防御力
  - `spd` (INTEGER): カードの速度（行動順決定）
  - `skill_type` (TEXT): スキルタイプ（attack/defense/heal/special）
  - `skill_name` (TEXT): スキル名
  - `skill_power` (INTEGER): スキル威力

#### 新規テーブル
- `battles`: 対戦履歴を保存
  - user_id, user_card_id, opponent_card_id, result, turn_count, battle_log
- `battle_stats`: ユーザーごとの対戦統計
  - user_id, total_battles, wins, losses, draws, win_rate

#### トリガーとインデックス
- 対戦結果保存時に自動で統計を更新するトリガー
- パフォーマンス向上のためのインデックス追加

### 2. バトルロジックの実装

#### 基本システム
- ターン制バトル（最大20ターン）
- SPDによる行動順決定
- 通常攻撃とスキル発動の確率システム

#### スキルシステム
- 攻撃型: 追加ダメージ
- 防御型: 防御力アップ
- 回復型: HP回復
- 特殊型: 特殊効果（高ダメージ）

#### ダメージ計算
- 通常攻撃: max(1, attacker.atk - defender.def)
- スキル攻撃: max(1, attacker.atk + attacker.skill_power - defender.def)
- スキル発動確率: min(70%, SPD × 10%)

### 3. APIエンドポイント

#### POST /api/battle/start
- 対戦を開始するAPI
- リクエスト: userCardId, opponentType
- レスポンス: 対戦結果、カード情報、バトルログ

#### GET /api/battle/[battleId]
- 特定の対戦情報を取得
- 対戦の詳細情報とログを返却

#### GET /api/battle/stats
- ユーザーの対戦統計を取得
- 総合成績と最近の対戦履歴

#### GET /api/user-cards
- ユーザーの所有カード一覧を取得
- 対戦カード選択用

### 4. フロントエンド実装

#### /battle ページ
- カード選択画面
- 対戦実行機能
- 結果表示画面
- レアリティごとの色分け
- カードステータス表示

#### /battle/stats ページ
- 総合成績表示（勝率、勝敗数など）
- 最近の対戦履歴
- 視覚的な統計表示

### 5. その他機能

#### レート制限
- battleStart: 20回/分
- battleGet: 100回/分
- battleStats: 50回/分

#### エラーハンドリング
- 適切なHTTPステータスコード
- ユーザーフレンドリーなエラーメッセージ
- ロギング実装

## 技術仕様

### 使用技術
- Next.js App Router
- TypeScript
- Supabase (PostgreSQL)
- Tailwind CSS
- React Hooks

### パフォーマンス
- 対戦処理: 1000ms以内目標
- APIレスポンス: 500ms以内目標
- 適切なインデックス設定

### セキュリティ
- ユーザー認証の必須化
- カード所有権の検証
- レート制限によるDoS対策

## ファイル一覧

### データベース
- `supabase/migrations/00002_add_battle_features.sql`

### 型定義
- `src/types/database.ts` (battle関連の型を追加)

### バトルロジック
- `src/lib/battle.ts`

### APIエンドポイント
- `src/app/api/battle/start/route.ts`
- `src/app/api/battle/[battleId]/route.ts`
- `src/app/api/battle/stats/route.ts`
- `src/app/api/user-cards/route.ts`

### フロントエンド
- `src/app/battle/page.tsx`
- `src/app/battle/stats/page.tsx`

### 設定
- `src/lib/rate-limit.ts` (battle関連のレート制限追加)

## 実装済みの要件

### 必須機能
- [x] カードにステータス（HP、ATK、DEF、SPD）の追加
- [x] 各カードにスキル設定
- [x] CPU対戦機能
- [x] 自動ターン制バトル
- [x] 勝敗判定
- [x] 対戦履歴の記録
- [x] 対戦統計の表示

### UI/UX
- [x] カード選択画面
- [x] 対戦結果表示
- [x] 統計情報表示
- [x] レアリティごとの色分け
- [x] レスポンシブデザイン

## 未実装の機能

### 拡張機能
- [ ] アニメーション効果（バトル演出）
- [ ] ユーザー同士の対戦
- [ ] より高度なAI
- [ ] リーグ戦やランキング機能

## テスト
- [x] APIエンドポイントの基本動作
- [x] フロントエンドのUI表示
- [ ] 完全なE2Eテスト（未実施）

## デプロイ手順

1. データベースマイグレーションの実行
```sql
-- Supabaseコンソールで以下を実行
-- supabase/migrations/00002_add_battle_features.sql の内容
```

2. 既存カードへのステータス設定
```sql
-- 既存カードにレアリティに応じたステータスを設定
UPDATE cards SET 
  hp = CASE 
    WHEN rarity = 'common' THEN 100 + floor(random() * 21)
    WHEN rarity = 'rare' THEN 120 + floor(random() * 21)
    WHEN rarity = 'epic' THEN 140 + floor(random() * 21)
    WHEN rarity = 'legendary' THEN 160 + floor(random() * 41)
    ELSE 100
  END,
  atk = CASE 
    WHEN rarity = 'common' THEN 20 + floor(random() * 11)
    WHEN rarity = 'rare' THEN 30 + floor(random() * 11)
    WHEN rarity = 'epic' THEN 40 + floor(random() * 6)
    WHEN rarity = 'legendary' THEN 45 + floor(random() * 6)
    ELSE 30
  END,
  def = CASE 
    WHEN rarity = 'common' THEN 10 + floor(random() * 6)
    WHEN rarity = 'rare' THEN 15 + floor(random() * 6)
    WHEN rarity = 'epic' THEN 20 + floor(random() * 6)
    WHEN rarity = 'legendary' THEN 25 + floor(random() * 6)
    ELSE 15
  END,
  spd = CASE 
    WHEN rarity = 'common' THEN 1 + floor(random() * 3)
    WHEN rarity = 'rare' THEN 3 + floor(random() * 3)
    WHEN rarity = 'epic' THEN 5 + floor(random() * 3)
    WHEN rarity = 'legendary' THEN 7 + floor(random() * 4)
    ELSE 5
  END,
  skill_type = (ARRAY['attack', 'defense', 'heal', 'special'])[floor(random() * 4) + 1],
  skill_name = CASE 
    WHEN random() < 0.25 THEN '強撃'
    WHEN random() < 0.5 THEN '鉄壁'
    WHEN random() < 0.75 THEN '回復'
    ELSE '特殊攻撃'
  END,
  skill_power = CASE 
    WHEN rarity = 'common' THEN 5 + floor(random() * 6)
    WHEN rarity = 'rare' THEN 10 + floor(random() * 6)
    WHEN rarity = 'epic' THEN 15 + floor(random() * 6)
    WHEN rarity = 'legendary' THEN 20 + floor(random() * 6)
    ELSE 10
  END
WHERE hp IS NULL;
```

3. アプリケーションのデプロイ
- コード変更をデプロイ

## 今後の拡張案

1. **対戦アニメーション**: カードの攻撃演出やダメージ表示
2. **PvP対戦**: ユーザー同士のリアルタイム対戦
3. **ギルド戦**: チームでの対戦機能
4. **トーナメント**: 定期的な大会開催
5. **カード強化**: 対戦での経験値によるカード育成