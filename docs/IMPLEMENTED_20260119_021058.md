# 実装内容

## Issue #46: Critical Bug - Twitch API Calls Fail Due to Missing Twitch Access Token Storage

### 概要
Twitch API コールが失敗するバグを修正しました。Supabase のセッションアクセストークンが誤って Twitch API 呼び出しに使用されていた問題を解決しました。

### 実装内容

#### 1. データベースマイグレーション
- **ファイル**: `supabase/migrations/00004_add_twitch_tokens_to_users.sql`
- **内容**: 
  - `users` テーブルに Twitch トークンを保存するカラムを追加
  - `twitch_access_token`: Twitch アクセストークン
  - `twitch_refresh_token`: Twitch リフレッシュトークン
  - `twitch_token_expires_at`: トークンの有効期限
  - RLS ポリシーを追加して、ユーザーが自身のトークンのみ読み取り/更新可能にする

#### 2. Twitch トークン管理ユーティリティ
- **ファイル**: `src/lib/twitch/token-manager.ts`
- **機能**:
  - `getTwitchAccessToken(twitchUserId)`: Twitch アクセストークンを取得、期限切れの場合は自動更新
  - `saveTwitchTokens(twitchUserId, tokens)`: Twitch トークンをデータベースに保存
  - `deleteTwitchTokens(twitchUserId)`: Twitch トークンをデータベースから削除
  - トークンの有効期限チェックと自動リフレッシュ機能

#### 3. Twitch OAuth コールバックの修正
- **ファイル**: `src/app/api/auth/twitch/callback/route.ts`
- **変更点**:
  - Twitch OAuth コールバックで取得したトークンをデータベースに保存
  - `users` テーブルの upsert にトークン情報を追加

#### 4. Twitch Rewards API の修正
- **ファイル**: `src/app/api/twitch/rewards/route.ts`
- **変更点**:
  - Supabase セッショントークンを使用した `getAccessToken()` 関数を削除
  - Twitch トークン管理ユーティリティを使用する `getTwitchAccessTokenOrError()` 関数を追加
  - GET メソッドで正しい Twitch アクセストークンを使用
  - POST メソッドで正しい Twitch アクセストークンを使用

#### 5. ログアウト時のトークン削除
- **ファイル**: `src/app/api/auth/logout/route.ts`
- **変更点**:
  - ログアウト時に Twitch トークンもデータベースから削除
  - GET メソッドと POST メソッドの両方に実装

#### 6. テストの追加
- **ファイル**: `tests/unit/twitch-token-manager.test.ts`
- **テスト内容**:
  - 有効なトークンを正しく返すテスト
  - トークンが存在しない場合は null を返すテスト
  - 期限切れのトークンを更新するテスト
  - トークンを保存するテスト
  - トークンを削除するテスト

### 検証
- ✓ Lint にパス
- ✓ すべてのユニットテストにパス (81 tests)

### メリット
1. **機能修復**: ストリーマー機能（チャンネルポイント報酬の管理）が正常に動作する
2. **トークン管理の改善**: Twitch トークンの保存、更新、削除が適切に行われる
3. **自動リフレッシュ**: トークンの有効期限が切れた場合、自動的に更新される
4. **セキュリティの維持**: トークンはデータベースに安全に保存され、RLS ポリシーで保護される
