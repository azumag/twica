# QA Report - 2026-01-17 23:34:00

## 対象実装

- Issue #25: Inconsistent Error Messages in API Responses

---

## Issue #25: Inconsistent Error Messages in API Responses

### 実装内容の確認

#### 1. ERROR_MESSAGES 定数の追加 ✅

**ファイル**: `src/lib/constants.ts`

- 行46-84: `ERROR_MESSAGES` 定数が追加されました
- すべてのエラーメッセージが英語に統一されています
- 認証エラー、リクエスト検証エラー、レート制限エラー、リソースエラー、ファイルアップロードエラー、一般エラーが含まれています

**評価**: 設計通り正しく実装されています。

#### 2. APIレスポンスタイプの追加 ✅

**ファイル**: `src/types/api.ts`

- `ApiErrorResponse`, `ApiRateLimitResponse` インターフェースが定義されています
- `UploadApiResponse`, `UploadApiErrorResponse` インターフェースが定義されています
- `GachaSuccessResponse`, `GachaErrorResponse` インターフェースが定義されています
- `BattleSuccessResponse`, `BattleErrorResponse` インターフェースが定義されています
- `CardResponse`, `CardsSuccessResponse`, `CardsErrorResponse`, `DeleteSuccessResponse` インターフェースが定義されています

**評価**: 設計通り正しく実装されています。

#### 3. APIルートの更新

**src/app/api/battle/start/route.ts** ✅
- 行34: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行48: `ERROR_MESSAGES.UNAUTHORIZED` を使用
- 行75: `ERROR_MESSAGES.USER_CARD_ID_REQUIRED` を使用

**src/app/api/battle/[battleId]/route.ts** ✅
- 行20: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行34: `ERROR_MESSAGES.UNAUTHORIZED` を使用

**src/app/api/battle/stats/route.ts** ✅
- 行18: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行32: `ERROR_MESSAGES.UNAUTHORIZED` を使用

**src/app/api/gacha/route.ts** ✅
- 行35: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行50: `ERROR_MESSAGES.UNAUTHORIZED` を使用
- 行58: `ERROR_MESSAGES.STREAMER_ID_REQUIRED` を使用
- 行69-83: GachaService エラーを ERROR_MESSAGES 定数にマッピング

**src/app/api/upload/route.ts** ✅
- 行19: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行35: `ERROR_MESSAGES.NOT_AUTHENTICATED` を使用
- 行50: `ERROR_MESSAGES.FILE_NAME_EMPTY` を使用

**src/app/api/cards/route.ts** ✅
- 行19: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行34: `ERROR_MESSAGES.UNAUTHORIZED` を使用
- 行44: `ERROR_MESSAGES.DROP_RATE_INVALID` を使用
- 行58: `ERROR_MESSAGES.FORBIDDEN` を使用
- 行108: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行123: `ERROR_MESSAGES.STREAMER_ID_MISSING` を使用
- 行136: `ERROR_MESSAGES.FORBIDDEN` を使用

**src/app/api/cards/[id]/route.ts** ✅
- 行23: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行38: `ERROR_MESSAGES.UNAUTHORIZED` を使用
- 行50: `ERROR_MESSAGES.DROP_RATE_INVALID` を使用
- 行65: `ERROR_MESSAGES.FORBIDDEN` を使用
- 行117: `ERROR_MESSAGES.RATE_LIMIT_EXCEEDED` を使用
- 行132: `ERROR_MESSAGES.UNAUTHORIZED` を使用
- 行150: `ERROR_MESSAGES.FORBIDDEN` を使用

**評価**: ほとんどのAPIルートが正しくエラーメッセージ定数を使用しています。

---

## テスト結果

### 単体テスト ❌

```
Test Files  1 failed | 5 passed (6)
     Tests  1 failed | 58 passed (59)
```

**失敗したテスト**:
- `tests/unit/upload.test.ts > POST /api/upload > レート制限 > レート制限超過で 429 エラーを返す`

**エラー内容**:
```
expected 'Too many requests. Please try again l…' to be 'リクエストが多すぎます。しばらく待ってから再試行してください。'
```

**原因**: テストが日本語のエラーメッセージを期待していますが、実装は英語のエラーメッセージを返しています。

### 統合テスト N/A

統合テストは実装されていません。

### ビルド ✅

```
✓ Compiled successfully in 2.5s
✓ Generating static pages (23/23)
```

ビルドが成功しました。

### ESLint ✅

ESLint エラーはありません。

### TypeScript ✅

TypeScript コンパイルエラーはありません。

---

## 受け入れ基準の確認

### Issue #25 受け入れ基準

- [x] `ERROR_MESSAGES` 定数が `src/lib/constants.ts` に追加される
- [x] `src/types/api.ts` が新規作成される
- [x] すべてのAPIルートでエラーメッセージ定数を使用する（大部分）
- [x] すべてのエラーメッセージが英語に統一される（大部分）
- [x] レート制限エラーメッセージが英語に更新される
- [x] APIレスポンス型が定義される
- [x] TypeScript コンパイルエラーがない
- [x] ESLint エラーがない
- [ ] 既存のAPIテストがパスする（1つ失敗）
- [x] APIが正しく動作する
- [x] 既存の機能に回帰がない（実装部分について）

---

## 修正が必要な点

### 1. アップロードバリデーションのエラーメッセージを英語に統一

**問題**: `src/lib/upload-validation.ts` の `getUploadErrorMessage` 関数が日本語のエラーメッセージを返しています。

**現状**:
```typescript
export function getUploadErrorMessage(error: UploadValidationError, maxSize?: number): string {
  switch (error) {
    case 'FILE_TOO_LARGE':
      const sizeInMB = maxSize ? (maxSize / (1024 * 1024)).toFixed(1) : '1'
      return `ファイルサイズは${sizeInMB}MB以下にしてください`  // 日本語
    case 'INVALID_FILE_TYPE':
      return '画像ファイル（JPEG, PNG）のみ対応しています'  // 日本語
    case 'NO_FILE':
      return 'ファイルが選択されていません'  // 日本語
    default:
      return 'アップロードできません'  // 日本語
  }
}
```

**期待される修正**:
```typescript
export function getUploadErrorMessage(error: UploadValidationError, maxSize?: number): string {
  switch (error) {
    case 'FILE_TOO_LARGE':
      return ERROR_MESSAGES.FILE_SIZE_EXCEEDED
    case 'INVALID_FILE_TYPE':
      return ERROR_MESSAGES.INVALID_FILE_TYPE
    case 'NO_FILE':
      return 'No file selected'  // 新しい定数を追加
    default:
      return 'Unable to upload file'
  }
}
```

### 2. テストファイルのエラーメッセージ期待値を英語に更新

**問題**: `tests/unit/upload.test.ts` が日本語のエラーメッセージを期待しています。

**修正が必要な箇所**:

1. 行49: レート制限エラーの期待値
   ```typescript
   // 修正前
   expect(body.error).toBe('リクエストが多すぎます。しばらく待ってから再試行してください。')
   
   // 修正後
   expect(body.error).toBe('Too many requests. Please try again later.')
   ```

2. 行93: ファイルなしエラーの期待値
   ```typescript
   // 修正前
   expect(body.error).toBe('ファイルが選択されていません')
   
   // 修正後
   expect(body.error).toBe('No file selected')
   ```

3. 行124: ファイルサイズエラーの期待値
   ```typescript
   // 修正前
   expect(body.error).toBe('ファイルサイズは1.0MB以下にしてください')
   
   // 修正後
   expect(body.error).toBe('File size exceeds the maximum allowed size')
   ```

4. 行155: ファイルタイプエラーの期待値
   ```typescript
   // 修正前
   expect(body.error).toBe('画像ファイル（JPEG, PNG）のみ対応しています')
   
   // 修正後
   expect(body.error).toBe('Invalid file type. Only JPEG and PNG are allowed')
   ```

### 3. 新しいエラーメッセージ定数の追加

**問題**: `src/lib/constants.ts` の `ERROR_MESSAGES` 定数に不足しているエラーメッセージがあります。

**追加が必要な定数**:
```typescript
export const ERROR_MESSAGES = {
  // ... 既存の定数 ...
  
  // File upload errors (追加が必要)
  FILE_NAME_EMPTY: 'File name is empty',
  FILE_SIZE_EXCEEDED: 'File size exceeds the maximum allowed size',
  INVALID_FILE_TYPE: 'Invalid file type. Only JPEG and PNG are allowed',
  NO_FILE_SELECTED: 'No file selected',  // 新規追加
  UNABLE_TO_UPLOAD: 'Unable to upload file',  // 新規追加
  
  // ... 既存の定数 ...
}
```

---

## 設計仕様との照合

### アーキテクチャ準拠

| 設計原則 | 評価 | 備考 |
|:---|:---|:---|
| Simple over Complex | ✅ | シンプルな実装 |
| Type Safety | ✅ | TypeScript 型定義が適切 |
| Separation of Concerns | ✅ | 適切なモジュール分割 |
| Security First | ✅ | 既存のセキュリティ維持 |
| Consistency | ⚠️ | アップロードバリデーションのエラーメッセージが統一されていない |
| Error Handling | ⚠️ | テストが期待値と一致していない |
| Observability | ✅ | 既存のログ/トレース維持 |

---

## 推奨事項

1. **アップロードバリデーションのエラーメッセージを英語に統一**: `src/lib/upload-validation.ts` の `getUploadErrorMessage` 関数を更新し、`ERROR_MESSAGES` 定数を使用するようにしてください。

2. **テストファイルの更新**: `tests/unit/upload.test.ts` の期待値を英語に更新してください。

3. **不足している定数の追加**: `ERROR_MESSAGES` 定数に `NO_FILE_SELECTED` と `UNABLE_TO_UPLOAD` を追加してください。

---

## 結論

**QA不合格** ❌

Issue #25の実装は大部分が正しく実装されていますが、以下の問題があります：

1. `src/lib/upload-validation.ts` のエラーメッセージが日本語のまま
2. テストファイルが日本語のエラーメッセージを期待している
3. 不足しているエラーメッセージ定数がある

これらの問題を修正した後、再テストが必要です。

---

## 実装エージェントへのフィードバック

以下の内容を修正してください：

1. `src/lib/upload-validation.ts` の `getUploadErrorMessage` 関数を更新し、英語のエラーメッセージを返すようにしてください。`ERROR_MESSAGES` 定数を使用することをお勧めします。

2. `tests/unit/upload.test.ts` のエラーメッセージ期待値を英語に更新してください。

3. `src/lib/constants.ts` の `ERROR_MESSAGES` 定数に不足しているエラーメッセージ（`NO_FILE_SELECTED`、`UNABLE_TO_UPLOAD`）を追加してください。

詳細は docs/QA.md を参照してください。
